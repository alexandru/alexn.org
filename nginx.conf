#
# To be included in the Nginx website config.
#

autoindex off;
error_page 404 /404.html;

location / {
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime off;

    # 5 minutes caching, with revalidation
    add_header Cache-Control "public, max-age=300, must-revalidate, stale-while-revalidate=3600";

    rewrite ^/rss/?$ /feeds/blog.xml redirect;
    rewrite ^/atom.xml$ /feeds/blog.xml permanent;
    rewrite ^/feed-wiki.xml$ /feeds/wiki.xml permanent;

    rewrite ^/feed.xml$ /feeds/blog.xml redirect;
    rewrite ^/blog/feed.xml$ /feeds/blog.xml redirect;
    rewrite ^/snippets/feed.xml$ /feeds/blog.xml redirect;
    rewrite ^/wiki/feed.xml$ /feeds/wiki.xml redirect;
    rewrite ^/links/feed.xml$ /feeds/links.xml redirect;
    rewrite ^/feeds/all.xml$ /feeds/blog.xml redirect;
    rewrite ^/feeds/links.xml$ https://links.alexn.org/feeds/shared redirect;

    rewrite ^/snippets/$ /blog/tag/snippet/ permanent;

    # -------------------------------------------
    rewrite ^/blog/2017/01/16/fixing-iterators.html$ /blog/2017/01/16/iterator/ permanent;
    rewrite ^/blog/2017/10/11/javascript-promise-memory-unsafe.html$ /blog/2017/10/11/javascript-promise-leaks-memory/ permanent;
    rewrite ^/blog/2022/10/27/things-i-love-about-scala/$ /blog/2022/10/27/immutable-collections-your-default/ permanent;
    rewrite ^/blog/2024/01/10/is-scala-in-trouble/$ /blog/2024/01/10/scala-future/ permanent;
    rewrite ^/docs/dialer.html$ /blog/2009/02/20/tips-for-creating-voip-dialer/ permanent;
    rewrite ^/pages/about.html$ /about/ permanent;
    rewrite ^/snippets/2019/09/02/blocking-task.scala.html$ /blog/2019/09/02/blocking-task.scala/ permanent;
    rewrite ^/snippets/2019/09/02/blocking-task.scala/$ /blog/2019/09/02/blocking-task.scala/ permanent;
    rewrite ^/snippets/2019/10/07/async-queue.ts.html$ /blog/2019/10/07/async-queue.ts/ permanent;
    rewrite ^/snippets/2019/10/07/async-queue.ts/$ /blog/2019/10/07/async-queue.ts/ permanent;
    rewrite ^/snippets/2019/11/29/sierpinski.hs.html$ /blog/2019/11/29/sierpinski.hs/ permanent;
    rewrite ^/snippets/2019/11/29/sierpinski.hs/$ /blog/2019/11/29/sierpinski.hs/ permanent;
    rewrite ^/snippets/2020/02/18/encrypt.sh.html$ /blog/2020/02/18/encrypt.sh/ permanent;
    rewrite ^/snippets/2020/02/18/encrypt.sh/$ /blog/2020/02/18/encrypt.sh/ permanent;
    rewrite ^/snippets/2020/03/18/send-mail.py.html$ /blog/2020/03/18/send-mail.py/ permanent;
    rewrite ^/snippets/2020/03/18/send-mail.py/$ /blog/2020/03/18/send-mail.py/ permanent;
    rewrite ^/snippets/2020/05/27/future-stack-overflow.scala.html$ /blog/2020/05/27/future-stack-overflow.scala/ permanent;
    rewrite ^/snippets/2020/05/27/future-stack-overflow.scala/$ /blog/2020/05/27/future-stack-overflow.scala/ permanent;
    rewrite ^/snippets/2020/07/30/from-resource-to-reactivestreams.scala.html$ /blog/2020/07/30/from-resource-to-reactivestreams.scala/ permanent;
    rewrite ^/snippets/2020/07/30/from-resource-to-reactivestreams.scala/$ /blog/2020/07/30/from-resource-to-reactivestreams.scala/ permanent;
    rewrite ^/snippets/2020/07/30/python-proxy.py.html$ /blog/2010/05/25/i-hate-null/ permanent;
    rewrite ^/snippets/2020/07/30/python-proxy.py/$ /blog/2010/05/25/i-hate-null/ permanent;
    rewrite ^/snippets/2020/08/03/on-error-retry-loop.scala.html$ /blog/2020/08/03/on-error-retry-loop/ permanent;
    rewrite ^/snippets/2020/08/03/on-error-retry-loop.scala/$ /blog/2020/08/03/on-error-retry-loop/ permanent;
    rewrite ^/snippets/2020/08/11/flow-sensitive-typing.ts.html$ /blog/2020/08/11/flow-sensitive-typing.ts/ permanent;
    rewrite ^/snippets/2020/08/11/flow-sensitive-typing.ts/$ /blog/2020/08/11/flow-sensitive-typing.ts/ permanent;
    rewrite ^/snippets/2020/08/13/sbt-fork-debug.sbt.html$ /blog/2020/08/13/sbt-fork-debug.sbt/ permanent;
    rewrite ^/snippets/2020/08/13/sbt-fork-debug.sbt/$ /blog/2020/08/13/sbt-fork-debug.sbt/ permanent;
    rewrite ^/snippets/2020/08/14/error-hierarchy.scala.html$ /blog/2020/08/14/error-hierarchy.scala/ permanent;
    rewrite ^/snippets/2020/08/14/error-hierarchy.scala/$ /blog/2020/08/14/error-hierarchy.scala/ permanent;
    rewrite ^/snippets/2020/08/27/safe-password.scala.html$ /blog/2020/08/27/safe-password.scala/ permanent;
    rewrite ^/snippets/2020/08/27/safe-password.scala/$ /blog/2020/08/27/safe-password.scala/ permanent;
    rewrite ^/snippets/2020/09/25/flow-processor-to-effect.html$ /blog/2020/09/25/flow-processor-to-effect/ permanent;
    rewrite ^/snippets/2020/09/25/flow-processor-to-effect/$ /blog/2020/09/25/flow-processor-to-effect/ permanent;
    rewrite ^/snippets/2020/10/05/running-integration-tests.scala.html$ /blog/2020/10/05/running-integration-tests.scala/ permanent;
    rewrite ^/snippets/2020/10/05/running-integration-tests.scala/$ /blog/2020/10/05/running-integration-tests.scala/ permanent;
    rewrite ^/snippets/2020/10/08/unlawful-effect.scala.html$ /blog/2020/10/08/unlawful-effect.scala/ permanent;
    rewrite ^/snippets/2020/10/08/unlawful-effect.scala/$ /blog/2020/10/08/unlawful-effect.scala/ permanent;
    rewrite ^/snippets/2020/10/12/effect-runtime.html$ /blog/2020/10/12/effect-runtime/ permanent;
    rewrite ^/snippets/2020/10/12/effect-runtime/$ /blog/2020/10/12/effect-runtime/ permanent;
    rewrite ^/snippets/2020/10/15/generic-ioapp-alternative.html$ /blog/2020/10/15/generic-ioapp-alternative/ permanent;
    rewrite ^/snippets/2020/10/15/generic-ioapp-alternative/$ /blog/2020/10/15/generic-ioapp-alternative/ permanent;
    rewrite ^/snippets/2020/11/13/list-blog-tags-in-folder.html$ /blog/2020/11/13/list-blog-tags-in-folder/ permanent;
    rewrite ^/snippets/2020/11/13/list-blog-tags-in-folder/$ /blog/2020/11/13/list-blog-tags-in-folder/ permanent;
    rewrite ^/snippets/2020/11/22/effecttestsuite-scala.html$ /blog/2020/11/22/effecttestsuite-scala/ permanent;
    rewrite ^/snippets/2020/11/22/effecttestsuite-scala/$ /blog/2020/11/22/effecttestsuite-scala/ permanent;
    rewrite ^/snippets/2020/12/06/execute-shell-command-in-fsharp.html$ /blog/2020/12/06/execute-shell-command-in-fsharp/ permanent;
    rewrite ^/snippets/2020/12/06/execute-shell-command-in-fsharp/$ /blog/2020/12/06/execute-shell-command-in-fsharp/ permanent;
    rewrite ^/snippets/2021/01/14/remove-blank-lines.html$ /blog/2021/01/14/remove-blank-lines/ permanent;
    rewrite ^/snippets/2021/01/14/remove-blank-lines/$ /blog/2021/01/14/remove-blank-lines/ permanent;
    rewrite ^/snippets/2021/01/20/tagless-final-vs-oop.html$ /blog/2021/01/20/tagless-final-vs-oop/ permanent;
    rewrite ^/snippets/2021/01/20/tagless-final-vs-oop/$ /blog/2021/01/20/tagless-final-vs-oop/ permanent;
    rewrite ^/snippets/2021/02/22/matomo-hosting-via-docker.html$ /blog/2021/02/22/matomo-hosting-via-docker/ permanent;
    rewrite ^/snippets/2021/02/22/matomo-hosting-via-docker/$ /blog/2021/02/22/matomo-hosting-via-docker/ permanent;
    rewrite ^/snippets/2021/08/02/unsafelazyresource-scala.html$ /blog/2021/08/02/unsafelazyresource-scala/ permanent;
    rewrite ^/snippets/2021/08/02/unsafelazyresource-scala/$ /blog/2021/08/02/unsafelazyresource-scala/ permanent;
    rewrite ^/snippets/2021/08/29/vscode-recommended-extensions-vscode-extensions-json.html$ /blog/2021/08/29/vscode-recommended-extensions-vscode-extensions-json/ permanent;
    rewrite ^/snippets/2021/08/29/vscode-recommended-extensions-vscode-extensions-json/$ /blog/2021/08/29/vscode-recommended-extensions-vscode-extensions-json/ permanent;
    rewrite ^/snippets/2022/01/22/cleanup-scala-project.html$ /blog/2022/01/22/cleanup-scala-project/ permanent;
    rewrite ^/snippets/2022/01/22/cleanup-scala-project/$ /blog/2022/01/22/cleanup-scala-project/ permanent;
    rewrite ^/wiki/web-apps.html$ /wiki/web/ permanent;
    rewrite ^/wiki/web-tricks.html$ /wiki/web/ permanent;
    # -------------------------------------------

    if (-f $request_filename) {
        break;
    }    
    rewrite ^/tag/(.*)$ /blog/tag/$1 permanent;
    # Source: https://stackoverflow.com/a/38238001
    if ($request_uri ~ ^/(.*)\.html(\?|$)) {
        return 301 /$1/$is_args$args;
    }
}

location /assets/ {
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime off;

    # 4 hours caching, with revalidation
    add_header Cache-Control "public, max-age=14400, must-revalidate, stale-while-revalidate=3600";
}

location /assets/misc/download/ {
    # 4 hours caching, with revalidation
    add_header Cache-Control "public, max-age=14400, must-revalidate, stale-while-revalidate=3600";
    # Force download
    add_header Content-Disposition "attachment";
}

location /wiki/assets/ {
    # 4 hours caching, with revalidation
    add_header Cache-Control "public, max-age=14400, must-revalidate, stale-while-revalidate=3600";
}

location /.well-known/webfinger {
    if ($arg_resource) {
        return 302 https://social.alexn.org/.well-known/webfinger?resource=acct%3Aalexelcu%40social.alexn.org;
    }
    return 400;
}
