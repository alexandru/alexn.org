<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="color-scheme" content="light dark">
    <!--https://developers.google.com/web/fundamentals/design-and-ux/browser-customization-->
    <meta name="theme-color" content="#493667">

    <title>Asynchronous Programming and Scala - Alexandru Nedelcu</title>
    

    <!-- Open Graph Meta -->
    <meta property="og:site_name" content="Alexandru Nedelcu">
    <meta property="og:title" content="Asynchronous Programming and Scala">
    <meta property="og:description" content="Asynchrony is everywhere and it subsumes concurrency. This article explains what asynchronous processing is and its challenges.">
    <meta property="og:url" content="https://alexn.org/blog/2017/01/30/asynchronous-programming-scala/">
    <meta property="article:published_time" content="2017-01-30T00:00:00+00:00">
    <meta property="og:type" content="article" />
    <meta property="og:image" content="https://alexn.org/assets/media/articles/nondet.png?202408120906" />
    <meta property="og:image:secure_url" content="https://alexn.org/assets/media/articles/nondet.png?202408120906" />
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:src" content="https://alexn.org/assets/media/articles/nondet.png?202408120906">
    <meta name="twitter:site" content="@alexelcu">
    <meta name="twitter:creator" content="@alexelcu">
    <meta name="twitter:title" content="Asynchronous Programming and Scala">
    <meta name="twitter:url" content="https://alexn.org/blog/2017/01/30/asynchronous-programming-scala/">
    <meta name="twitter:description" content="Asynchrony is everywhere and it subsumes concurrency. This article explains what asynchronous processing is and its challenges.">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" sizes="48x48" />
    <link rel="icon" href="/assets/logo/16px.png" sizes="16x16" />
    <link rel="icon" href="/assets/logo/32px.png" sizes="32x32" />
    <link rel="icon" href="/assets/logo/192px.png" sizes="192x192" />
    <link rel="icon" href="/assets/logo/270px.png" sizes="270x270" />
    <link rel="icon" href="/assets/logo/512px.png" sizes="512x512" />
    <link rel="apple-touch-icon-precomposed" href="/assets/logo/180px.png" />
    <meta name="msapplication-TileImage" content="/assets/logo/270px.png" />

    <!-- Come and get me RSS readers -->
    <link rel="alternate" type="application/rss+xml" title="All articles (blog + wiki)" href="/feeds/all.xml" />

    <!-- Points at alexn.org, taking care of the search-engine indexing of mirrors: -->
    <link rel="canonical" href="https://alexn.org/blog/2017/01/30/asynchronous-programming-scala/">

    <style type="text/css" media="all">
      /*! normalize.css v6.0.0 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}article,aside,footer,header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figcaption,figure,main{display:block}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:rgba(0,0,0,0);-webkit-text-decoration-skip:objects}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}dfn{font-style:italic}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not(:root){overflow:hidden}button,input,optgroup,select,textarea{margin:0}button,input{overflow:visible}button,select{text-transform:none}button,html [type=button],[type=reset],[type=submit]{-webkit-appearance:button}button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted ButtonText}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{display:inline-block;vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details,menu{display:block}summary{display:list-item}canvas{display:inline-block}template{display:none}[hidden]{display:none}body .intro{font-size:1.25em;line-height:1.7}h1,.h1,h2,.h2,h3,.h3,h4,.h4,h5,.h5,h6,.h6{margin:.5rem 0 1.5rem;font-family:"Gill Sans",Tahoma,Helvetica,Arial,sans-serif}h1,.h1{font-size:2em;line-height:1.25}@media(min-width: 43.75em){h1,.h1{font-size:2.5em;line-height:1.125}}@media(min-width: 56.25em){h1,.h1{font-size:3em;line-height:1.05}}h2,.h2{font-size:1.625em;line-height:1.15384615}@media(min-width: 43.75em){h2,.h2{font-size:2em;line-height:1.25}}@media(min-width: 56.25em){h2,.h2{font-size:2.25em;line-height:1.25}}h3,.h3{font-size:1.375em;line-height:1.13636364}@media(min-width: 43.75em){h3,.h3{font-size:1.5em;line-height:1.25}}@media(min-width: 56.25em){h3,.h3{font-size:1.75em;line-height:1.25}}h4,.h4{font-size:1.125em;line-height:1.11111111}@media(min-width: 43.75em){h4,.h4{line-height:1.22222222}}.button__outline,.button-tertiary,.button-secondary,.button{background-color:#00649e;display:inline-block;position:relative;font-family:"Gill Sans",Tahoma,Helvetica,Arial,sans-serif;text-decoration:none;color:#fff;font-size:1em;line-height:1.2em;font-weight:normal;padding:.5em 1.5em;border:0;border-radius:4px;cursor:pointer;margin-bottom:.5em;transition:background-color .14s ease-in-out}.button__outline:hover,.button-tertiary:hover,.button-secondary:hover,.button:hover,.button__outline:focus,.button-tertiary:focus,.button-secondary:focus,.button:focus{color:#fff;text-decoration:none;background-color:#00446b}.button__outline:active,.button-tertiary:active,.button-secondary:active,.button:active{top:1px}.button-secondary{background-color:#008bd8}.button-secondary:hover{background-color:#006aa5}.button-tertiary{background-color:#aaa}.button-tertiary:hover{background-color:#919191}.button__outline{background-color:rgba(0,0,0,0);border:3px solid #00649e;color:#00649e}.button__outline:hover{background-color:#00649e;color:#fff}span.link-logo{text-decoration:none !important}span.link-logo img{height:28px;width:28px;vertical-align:middle;margin-right:10px}a span.link-logo img{filter:invert(17%) sepia(47%) saturate(1856%) hue-rotate(174deg) brightness(95%) contrast(97%)}label{display:block;margin-bottom:5px}input[type=text],input[type=email],input[type=phone],input[type=password],input[type=number],input[type=search],textarea{background:#e6e6e6;padding:5px;outline:none;border:none;height:44px;width:300px;margin-bottom:.5rem;font-size:100%}input[type=text]:focus,input[type=email]:focus,input[type=phone]:focus,input[type=password]:focus,input[type=number]:focus,input[type=search]:focus,textarea:focus{border:1px solid #00649e}input[type=text].full-width,input[type=email].full-width,input[type=phone].full-width,input[type=password].full-width,input[type=number].full-width,input[type=search].full-width,textarea.full-width{width:100%}textarea{height:132px}form{margin-bottom:40px}form .field{margin-bottom:20px}form label{color:#666}form .note-warning{margin-top:5px;color:#aaa}form .req{font-style:italic}form .asterisk{color:darkred}form .error .reason{margin-top:5px;color:#ff4136}form .error input[type=text],form .error input[type=email],form .error input[type=phone],form .error input[type=password],form .error input[type=number],form .error input[type=search],form .error textarea{border-color:#ff4136}table{width:100%;border:1px solid #d0d0d0;margin-bottom:1.5em}table caption{margin:0 0 7px;font-size:.75em;color:#aaa;text-transform:uppercase;letter-spacing:1px}tr{border-bottom:1px solid #d0d0d0}tr:nth-child(even){background-color:#f7f7f7}td{padding:7px;border-right:1px solid #d0d0d0}td:last-child{border-right:0}th{background-color:#f7f7f7;border-bottom:1px solid #d0d0d0;border-right:1px solid #d0d0d0}th:last-child{border-right:0}pre>code{color:#333;background:#f8f8f8;display:block;white-space:pre;overflow:auto;word-wrap:normal;border:1px solid #e8e8e8;line-height:1.3;font-size:.9em}:not(pre)>code{background-color:rgba(27,31,35,.05);padding:.2em .4em;margin:0;font-size:85%;border-radius:3px}div.formula-code{color:#333;background:#f8f8f8;display:block;white-space:pre;overflow:auto;word-wrap:normal;border:1px solid #e8e8e8;margin:0 0 20px 0}div.formula-code .MathJax_Display{margin:0 !important}#isso-thread *{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}#isso-thread{padding:0;margin:0}h4.isso-thread-heading{color:#555;font-weight:bold}.isso-feedlink{float:right;padding-left:1em}.isso-feedlink a{font-size:.8em;vertical-align:bottom}.isso-comment{max-width:68em;margin:0 auto}.isso-preview .isso-comment{padding-top:0;margin:0}.isso-comment:not(:first-of-type),.isso-follow-up .isso-comment{border-top:1px solid rgba(0,0,0,.1);margin-bottom:.5em}.isso-avatar{display:block;float:left;margin:.95em .95em 0}.isso-avatar svg{max-width:48px;max-height:48px;width:100%;height:100%;border:1px solid rgba(0,0,0,.2);border-radius:3px;box-shadow:0 1px 2px rgba(0,0,0,.1)}.isso-text-wrapper{display:block;padding:.95em}.isso-follow-up{padding-left:calc(7% + 20px)}.isso-comment-footer{font-size:.95em}.isso-comment-header{font-size:.85em}.isso-comment-header a{text-decoration:none}.isso-comment-header .isso-spacer{padding:0 6px}.isso-spacer,.isso-permalink,.isso-note,.isso-parent{color:gray;font-weight:normal;text-shadow:none}.isso-spacer:hover,.isso-permalink:hover,.isso-note:hover,.isso-parent:hover{color:#606060}.isso-note{float:right}.isso-author{font-weight:bold;color:#555}.isso-page-author-suffix{font-weight:bold;color:#2c2c2c}.isso-textarea,.isso-preview{margin-top:.2em;width:100%;border:1px solid #f0f0f0;border-radius:2px;box-shadow:0 0 2px #888}.isso-text p{margin-top:.2em}.isso-text p:last-child{margin-bottom:.2em}.isso-text h1,.isso-text h2,.isso-text h3,.isso-text h4,.isso-text h5,.isso-text h6{font-size:130%;font-weight:bold}.isso-text pre{background:#eee;border:1px solid #ddd;padding:10px 15px;color:#4d4d4c;overflow:auto;line-height:1.5em}.isso-text :not(pre)>code{padding:.2em .4em;margin:0;font-size:85%;background-color:#eee;border-radius:6px}.isso-comment-footer{font-size:.8em;color:gray;clear:left}.isso-feedlink,.isso-comment-footer a{font-weight:bold;text-decoration:none}.isso-feedlink:hover,.isso-comment-footer a:hover{color:#111;text-shadow:#aaa 0 0 1px}.isso-comment-footer>a{position:relative;top:.2em}.isso-comment-footer>a+a{padding-left:1em}.isso-comment-footer .isso-votes{color:gray}.isso-upvote svg,.isso-downvote svg{position:relative;top:.2em}.isso-comment .isso-postbox{margin-top:.8em}.isso-comment.isso-no-votes>*>.isso-comment-footer .isso-votes{display:none}.isso-postbox{max-width:68em;margin:0 auto 2em;clear:right}.isso-form-wrapper{display:block;padding:0}.isso-textarea,.isso-preview{margin:0 0 .3em;padding:.4em .8em;border-radius:3px;background-color:#fff;border:1px solid rgba(0,0,0,.2);box-shadow:0 1px 2px rgba(0,0,0,.1)}.isso-textarea{outline:0;width:100%;resize:none}.isso-form-wrapper input[type=checkbox]{vertical-align:middle;position:relative;bottom:1px;margin-left:0}.isso-notification-section{font-size:.9em;padding-top:.3em;display:none;padding-bottom:10px}.isso-auth-section{display:block}.isso-textarea:focus,.isso-input-wrapper input:focus,.isso-auth-section input:focus{outline:2px solid #3584e4}.isso-input-wrapper{display:inline-block;position:relative;margin:0 1% 0 0}.isso-input-wrapper input{display:block;padding:.3em 10px;max-width:100%;border-radius:3px;background-color:#fff;line-height:1.4em;border:1px solid rgba(0,0,0,.2);box-shadow:0 1px 2px rgba(0,0,0,.1)}.isso-input-wrapper label{display:block;line-height:1.4em;height:1.4em}.isso-post-action{display:block;float:right;margin:1.4em 0 0 5px}.isso-post-action>input{padding:calc(.3em - 1px);border-radius:2px;border:1px solid #ccc;background-color:#ddd;cursor:pointer;outline:0;line-height:1.4em;box-shadow:0 1px 2px rgba(0,0,0,.1)}.isso-post-action>input:hover{background-color:#ccc}.isso-post-action>input:active{background-color:#bbb}.isso-preview,.isso-post-action input[name=edit],.isso-postbox.isso-preview-mode>.isso-form-wrapper input[name=preview],.isso-postbox.isso-preview-mode>.isso-form-wrapper .isso-textarea{display:none}.isso-postbox.isso-preview-mode>.isso-form-wrapper .isso-preview{display:block}.isso-postbox.isso-preview-mode>.isso-form-wrapper input[name=edit]{display:inline}.isso-preview{background-color:#f8f8f8;background:repeating-linear-gradient(-45deg, #f8f8f8, #f8f8f8 10px, #fff 10px, #fff 20px)}.isso-target{animation:isso-target-fade 5s ease-out}@keyframes isso-target-fade{0%{background-color:#eee5a1}}@media screen and (max-width: 600px){.isso-input-wrapper{display:block;max-width:100%;margin:0 0 .3em}.isso-input-wrapper input{width:100%}.isso-post-action{margin-top:0}}html.dark-reader body{background-image:none}html.dark-reader body .footer{background-image:none}html{box-sizing:border-box;background-color:#fefefe}*,*:before,*:after{box-sizing:inherit}body{background-color:#fff;background-image:url("/assets/media/tile-graphpaper.png");font-family:Georgia,Times,serif;line-height:1.75;font-size:112.5%;color:#111;overflow-x:hidden;margin:0}body p,body ul{margin:0 0 2rem}body code{font-family:"ui-monospace","SFMono-Regular","SF Mono",Menlo,Consolas,"Liberation Mono",monospace;font-variant-ligatures:common-ligatures}::-moz-selection{background:#00649e;color:#fff}::selection{background:#00649e;color:#fff}img,video,audio,iframe,object{max-width:100%;height:auto}.container{max-width:610px;padding:0 20px;margin-left:auto;margin-right:auto}a{color:#00649e}a:hover{color:#003452}.nav-collapse{z-index:1}.nav-collapse ul{margin:0;padding:0;width:100%;display:block;list-style:none}.nav-collapse ul li{width:100%;display:block;background:#57457a;border-bottom:2px solid #675291}.nav-collapse ul li a{color:#fff;text-decoration:none;display:block;padding:5px 2rem}.nav-collapse{clip:rect(0 0 0 0);max-height:0;position:absolute;display:block;overflow:hidden;transform:scale(1);transform-origin:0 0;clear:both;width:100%}.no-js .nav-collapse{position:relative;max-height:none}.nav-collapse.opened{max-height:9999px}.nav-toggle{-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-o-user-select:none;user-select:none;float:right;line-height:2em;margin-top:.5em;background-color:#00649e;border-radius:4px;padding:0 .5em;color:#fff;text-decoration:none;position:relative;right:2rem;transition:all .2s ease-in-out}.nav-toggle:hover{color:#fff;background-color:#00446b}.noList{list-style:none;padding-left:0;margin-left:0}dt{font-weight:bold}dd{margin:0 0 1.5rem}.post ul ul,.post ul ol,.post ol ul,.post ol ol{margin:0}ul.links-with-icons,ol.links-with-icons{list-style:none;padding-left:20px}.pageTitle{margin:2rem auto 1em;text-align:center}.pageTitle .type{color:#888}.content{padding-top:1em}.js .header{height:3em}.header{background-color:#473864;background-size:cover;background-position:center center;color:#fff;padding:0}.header .container{padding:0;max-width:100%}.header h1{margin:0;float:left;padding-left:2rem;font-size:1em;line-height:3em;font-family:"Gill Sans",Tahoma,Helvetica,Arial,sans-serif;text-transform:lowercase}.header h1 .wide1,.header h1 .wide2{display:none}.header h1 a{color:#e9d9ff;text-decoration:none;font-family:"Gill Sans",Tahoma,Helvetica,Arial,sans-serif;letter-spacing:.1rem;font-variant-ligatures:common-ligatures;text-shadow:0px 0px 4px #000}.post .postTitle{text-align:center;margin-top:2rem;margin-bottom:1rem}.post blockquote{color:#57606a;border-left:.25em solid #d9d9d9;display:block;margin:0;padding-left:1rem}.post blockquote p{margin-left:0;margin-right:0;width:100%}.post .meta,.post #article-details{text-align:center;color:gray;font-family:Georgia,Times,serif;font-weight:normal}.post .meta a,.post #article-details a{color:#1d8dcd;text-decoration:none}.post .meta a:hover,.post #article-details a:hover{text-decoration:underline}.post figure{margin:3rem 0}.post figure figcaption{text-align:center;font-size:.9em;font-style:italic;color:#5e5e5e}.post figure img{margin:0 auto;display:block}.post img{border-radius:3px}.post img.left{float:left;margin-right:1em;margin-bottom:1em}.post img.right{float:right;margin-left:1em;margin-bottom:1em}.post pre>code{clear:both;margin-bottom:2rem}.post .intro::first-letter{color:#00649e;font-size:250%;line-height:1}.post .featuredImage{position:relative;margin-top:2rem}.post .featuredImage img{margin-bottom:0}.post #article-details{border:0;border-top:2px solid #d9d9d9;width:100%;text-align:left;margin:0 auto;padding:1rem 0}.post #article-details #all-categories{margin-top:1rem;padding-top:1rem;border-top:1px solid #e6e6e6}.post .snippets ul{margin-top:1rem}.post .snippets ul li time{font-weight:normal;font-size:.9em;color:gray}.post hr{border-style:solid;border-color:#d9d9d9;border-width:1.5px 0 0 0;margin-top:2rem;margin-bottom:2rem}.post div.footnotes{font-size:85%}.post div.footnotes ol{margin:0;margin-bottom:2rem;width:100%;list-style-position:outside;padding-left:30px}.post div.footnotes li p{margin-left:0;margin-right:0;width:100%}.post.snippet .postTitle{font-size:100%}.post div.related{border-top:1.5px solid #d9d9d9}.post div.related,div.archive_list{width:100%;margin:0 auto}.post div.related h2,div.archive_list h2{margin:0;margin-top:1rem;color:#000}.post div.related div.container,div.archive_list div.container{display:block;margin-top:2rem}.post div.related div.container div.item,div.archive_list div.container div.item{clear:left;margin-bottom:1rem;width:100%}.post div.related div.container div.item div.related-image,div.archive_list div.container div.item div.related-image{display:block;float:right;margin-bottom:1rem;margin-left:1rem;width:42px;height:42px;background-position:center;background-repeat:no-repeat;background-size:cover;background-color:rgba(0,0,0,.1);border-radius:2px;text-decoration:none;padding:1rem}.post div.related div.container div.item .related-meta,div.archive_list div.container div.item .related-meta{font-family:Georgia,Times,serif;font-weight:normal;font-size:.9em;color:gray;line-height:1.5}.post div.related div.container div.item .related-meta a,div.archive_list div.container div.item .related-meta a{color:#1d8dcd;text-decoration:none}.post div.related div.container div.item .related-meta a:hover,div.archive_list div.container div.item .related-meta a:hover{text-decoration:underline}div.archive_list{position:relative}div.archive_list h3{margin-top:4rem;color:#a66c75}div.archive_list:before{content:"";position:absolute;bottom:-2rem;left:0;background:#e6e6e6;height:2px;width:60px}div.archive_list.last:before{display:none}.postNav{border-top:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;overflow:hidden}.postNav .prev,.postNav .next{display:block;width:100%;height:5rem;overflow:hidden;position:relative;font-family:"Gill Sans",Tahoma,Helvetica,Arial,sans-serif;font-weight:800;font-size:.9em;text-transform:uppercase;text-align:center}.postNav .prev img,.postNav .next img{z-index:1;display:block;position:absolute;top:50%;transform:translateY(-50%);left:0;width:100%;height:auto}.postNav .prev span,.postNav .next span{z-index:10;position:relative;padding:.5rem;position:absolute;top:50%;transform:translateY(-50%);width:100%;line-height:1.4}.postNav .prev.image,.postNav .next.image{text-decoration:none;color:#fff;text-shadow:1px 1px 3px rgba(0,0,0,.8);padding:0 .5rem;position:relative;transition:all .2s ease-in-out}.postNav .prev:hover.image,.postNav .next:hover.image{opacity:.8}.postNav .prev span{left:0}.postNav .next span{right:0}.footer{margin-top:2rem;clear:both;background:#fafafa}.footer hr{display:block;clear:both;border:1px solid #eaeaea;margin:1rem 0}.footer #footer-comments-widget{border-bottom:2px solid #eaeaea;margin-bottom:1rem}.footer .contributions{padding:1rem 0}.footer .contributions .note-warning{border:1px solid #e1e4e8;background-color:#f6f8fa;border-radius:3px;padding:16px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin-bottom:1rem}.footer .contributions .note-warning .extra{color:#586069}.footer .contributions .note-warning .extra .link-logo img{opacity:.6}.footer .contributions #disqus_thread{max-width:90%;margin:0 auto;overflow:auto}.footer .contributions h2,.footer .contributions h3{margin-top:0;color:#a66c75}.footer .contributions #share{border-bottom:1px solid #c69aa1}.footer .contributions #isso-thread{font-size:90%}.footer .contributions #isso-thread .isso-comment>.isso-text-wrapper>div.isso-comment-header{display:inline-block;vertical-align:middle}.footer .contributions #isso-thread .isso-comment>.isso-text-wrapper>div.isso-text{clear:both}.footer .contributions #isso-thread .isso-comment>.isso-text-wrapper p{margin:0 0 .7rem}.footer .contributions #isso-thread .isso-comment>.isso-text-wrapper blockquote{color:#777;margin:5px 0;padding:5px;padding-left:10px;border-left:4px solid #ddd;background-color:#f7f7f7}.footer .contributions #isso-thread .isso-comment>.isso-text-wrapper code{color:#333;background:#f8f8f8}.footer .contributions #isso-thread .isso-comment>.isso-text-wrapper pre{color:#333;background:#f8f8f8;display:block;white-space:pre;overflow:auto;word-wrap:normal;border:1px solid #e8e8e8}.footer .contributions #isso-thread .isso-form-wrapper{font-size:90%}.footer .contributions #isso-thread .isso-textarea-wrapper textarea.isso-textarea{height:80px}.footer .contributions #isso-thread .isso-auth-section{font-size:90%}.footer .contributions #isso-thread .isso-auth-section .isso-input-wrapper{display:block}.footer .contributions #isso-thread .isso-auth-section .isso-input-wrapper input{width:100%;height:auto}.footer .contributions #isso-thread .isso-auth-section .isso-post-action{margin:.5em 0px 0px 5px}.footer .contributions #isso-thread .isso-auth-section .isso-post-action input{padding:.2em 1em;border-radius:4px;border:0;margin-right:5px}.footer .contributions #isso-thread .isso-auth-section .isso-post-action input[type=submit]{background-color:#00649e;color:#fff;font-weight:bold;border:0;cursor:pointer}.footer .contributions #isso-thread .isso-auth-section .isso-post-action input[type=submit]:hover{color:#fff;background-color:#007bc2}.footer .contributions #isso-thread #isso-root{clear:both}.footer .contributions #isso-thread .isso-avatar img{max-width:24px;max-height:24px;border-radius:3px}.footer .contributions #mc_embed_signup form{margin-bottom:0}.footer .bottom{background:#f2f2f2;font-size:.8em;color:#656c7a;border-top:2px solid #eaeaea;border-bottom:2px solid #eaeaea;padding:1rem 0}.footer .bottom .container{max-width:90%;text-align:center}.footer .bottom .container .copy,.footer .bottom .container .links{display:block}.pagination div.page_number{color:gray;border-top:1px dashed #aaa;padding:1rem 0}.pagination .next{float:left}.pagination .previous{float:right}.posts li{margin-bottom:4rem;position:relative}.posts li:before{content:"";position:absolute;bottom:-2rem;left:0;background:#e6e6e6;height:2px;width:60px}.posts li:last-child:before{display:none}.posts li a{text-decoration:none}.posts li a:hover{text-decoration:underline}.posts li .meta{font-family:Georgia,Times,serif;font-weight:normal;font-size:.9em;color:gray}.posts li .meta time{display:block}.posts li .meta a{color:#1d8dcd;text-decoration:none}.posts li .meta a:hover{text-decoration:underline}.posts li h3{margin:0 0 .5em}#home{padding-top:2em}#home .postTitle{text-align:center}img.right{float:none}.patreon-button img{width:170px;height:40px}.post.about img.avatar{width:100px}.small-note{font-size:80%;color:gray}.video .youtube-play-link{position:relative;display:block;box-shadow:0px 0px 5px 0px rgba(50,50,50,.3);border-radius:3px}.video .youtube-play-link:before{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);-webkit-transform:translate(-50%, -50%);display:block;width:80px;height:56px;font-size:1px;content:" ";opacity:.8;z-index:100;background-image:url(/assets/media/youtube.png);background-size:80px 56px;background-position:center;background-repeat:no-repeat;transition-timing-function:ease-in;transition:opacity .3s}.video .youtube-play-link:hover:before{opacity:1}.video .youtube-play-link img.play-thumb{display:block;min-height:70px}.video .video-container{position:relative;padding-bottom:56.25%;padding-top:10px;height:0;overflow:hidden}.video .video-container iframe,.video .video-container object,.video .video-container embed{position:absolute;top:0;left:0;width:100%;height:100%}.no-js .only-js{display:none}.no-js .video .video-container{display:none}.posts img{border-radius:3px}.posts figure{margin:1rem 0}.posts figure figcaption{text-align:center;font-size:.9em;font-style:italic;color:#5e5e5e}.posts figure img{margin:0 auto;display:block}.hidden{display:none}.post header nav.toc{border-top:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;margin-bottom:1rem}.post header nav.toc ul{margin-bottom:1rem}.post header nav.toc .toc-title{font-weight:bold;margin:1rem auto 1rem}.post .warn-bubble,.post .info-bubble,.post.privacy_policy #opt_out_frame iframe{background-color:rgba(226,231,240,.3);color:#555;padding:7px;border:2px dashed #e2f0e7;border-radius:10px}.post .warn-bubble{color:#655;background-color:rgba(243,235,237,.3);border:2px dashed #f6ddd7}.post pre>code,.post pre>code.hljs{border-radius:0;margin:0 auto;padding:2px;width:100%}.post .formula-code,.post pre>code{font-size:90%}.post.privacy_policy #opt_out_frame iframe{width:100%;height:300px}h1,h2,h3,h4,h5,h6{color:#111;font-weight:700}h1 a.anchor,h2 a.anchor,h3 a.anchor,h4 a.anchor,h5 a.anchor,h6 a.anchor{color:#d3d3d3;font-weight:normal;text-decoration:none}h1 a.anchor:hover,h2 a.anchor:hover,h3 a.anchor:hover,h4 a.anchor:hover,h5 a.anchor:hover,h6 a.anchor:hover{color:gray}.nobr{white-space:nowrap}.clearfix{transform:scale(1);transform-origin:0 0}.clearfix:before,.clearfix:after{content:" ";display:block;height:0;overflow:hidden}.clearfix:after{clear:both}@media only screen and (min-width: 375px){.header h1 .wide1{display:inline}}@media only screen and (min-width: 500px){.header h1 .wide1,.header h1 .wide2{display:inline}.post.privacy_policy #opt_out_frame iframe{height:260px}}@media only screen and (min-width: 800px){body{font-size:125%}.content{padding-top:0;position:relative;z-index:1}.container{max-width:880px;margin-left:auto;margin-right:auto;padding:0}#home .posts,#home .pageTitle,#home .pagination,#home .archive_list{width:75%;float:none;margin:0 auto 1.5em}#home .pageTitle{margin:2rem auto 1em}.js .header,.no-js .header{height:7em;position:relative;padding-bottom:0}.js .header .wide1,.js .header .wide2,.no-js .header .wide1,.no-js .header .wide2{display:inline}.js .header .container,.no-js .header .container{position:relative;top:50%;transform:translateY(-50%);max-width:880px;overflow:hidden}.js .header .container .inner-container,.no-js .header .container .inner-container{width:75%;margin:0 auto}.js .header h1,.no-js .header h1{font-size:2em;line-height:1;padding-left:0}.js .header nav,.no-js .header nav{float:left;clear:left}.js .header nav ul,.no-js .header nav ul{margin:0}.js .header nav ul li,.no-js .header nav ul li{display:inline;line-height:3em;background:none;padding:0 5px;border:none}.js .header nav ul li a,.no-js .header nav ul li a{color:#fff;font-size:.9em;text-decoration:none;padding:0 .25em}.js .header nav ul li a:hover,.no-js .header nav ul li a:hover{color:#ccc}.js .header nav ul li.current,.no-js .header nav ul li.current{padding-bottom:.25em;border-bottom:4px solid rgba(255,255,255,.4)}.nav-collapse{position:relative;max-height:none}.nav-collapse.closed{max-height:none}.nav-collapse ul li a{display:inline-block}.nav-toggle{display:none}.post h1,.post h2,.post h3,.post h4,.post h5,.post h6,.post p,.post ul,.post ol,.post dl,.post .pageTitle,.post .content,.post .page-width,.post blockquote,.post div.footnotes{width:75%;float:none;margin:0 auto 2rem}.post hr{width:75%}.post div.footnotes{margin:0 auto 1rem}.post div.footnotes p{margin-bottom:1rem}.post h1,.post .h1,.post h2,.post .h2,.post h3,.post .h3,.post h4,.post .h4,.post h5,.post .h5,.post h6,.post .h6{margin:1rem auto}.post .pageTitle{margin:2rem auto 1em}.post .featuredImage{position:relative;margin-top:2rem}.post pre>code,.post pre>code.hljs{font-size:.8em;padding:1em;border-radius:4px}.post div.formula-code{padding:20px 10px}.post blockquote{padding-left:2rem}.post.snippet .postTitle{font-size:120%}.postNav .prev,.postNav .next{width:50%}.postNav .prev{float:left;text-align:left}.postNav .next{text-align:right;float:right}.footer .container{max-width:880px}.footer .contributions{width:75%;margin:0 auto}.footer .contributions .avatar img{max-width:48px;max-height:48px;border-radius:5px}.footer .contributions #isso-thread .isso-avatar img{max-width:32px;max-height:32px}.footer .bottom .container .copy::after{content:"|"}.footer .bottom .container .copy,.footer .bottom .container .links{display:inline}.contactContent{max-width:48%;margin-right:2%;float:left}#contact form{max-width:48%;width:48%;float:right;margin-right:0}img.right{float:right}.post.about img.avatar{width:300px}div.header nav{text-shadow:0px 0px 4px #000}#abonament form{width:75%;margin:0 auto 2rem}.post div.related{width:75%}.post #article-details{width:75%}.post.privacy_policy #opt_out_frame iframe{height:190px}.video .youtube-play-link:before{width:120px;height:84px;background-size:120px 84px}}@media only screen and (min-width: 1200px){body{font-size:137.5%}.container{max-width:990px}.container .inner-container{width:75%;margin:0 auto}.js .header .container,.no-js .header .container{max-width:990px}.post.privacy_policy #opt_out_frame iframe{height:180px}.footer .container{max-width:990px}.post.snippet .postTitle{font-size:140%}}@media(prefers-color-scheme: light){pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!
  Theme: StackOverflow Light
  Description: Light theme as used on stackoverflow.com
  Author: stackoverflow.com
  Maintainer: @Hirse
  Website: https://github.com/StackExchange/Stacks
  License: MIT
  Updated: 2021-05-15

  Updated for @stackoverflow/stacks v0.64.0
  Code Blocks: /blob/v0.64.0/lib/css/components/_stacks-code-blocks.less
  Colors: /blob/v0.64.0/lib/css/exports/_stacks-constants-colors.less
*/.hljs{color:#2f3337;background:#f6f6f6}.hljs-subst{color:#2f3337}.hljs-comment{color:#656e77}.hljs-attr,.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-section,.hljs-selector-tag{color:#015692}.hljs-attribute{color:#803378}.hljs-name,.hljs-number,.hljs-quote,.hljs-selector-id,.hljs-template-tag,.hljs-type{color:#b75501}.hljs-selector-class{color:#015692}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-string,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#54790d}.hljs-meta,.hljs-selector-pseudo{color:#015692}.hljs-built_in,.hljs-literal,.hljs-title{color:#b75501}.hljs-bullet,.hljs-code{color:#535a60}.hljs-meta .hljs-string{color:#54790d}.hljs-deletion{color:#c02d2e}.hljs-addition{color:#2f6f44}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}}@media(prefers-color-scheme: dark){:root{color-scheme:light dark}html,body,*{scrollbar-width:thin;scrollbar-color:#727173 #1e2223}body::-webkit-scrollbar,*::-webkit-scrollbar{width:10px}body::-webkit-scrollbar-track,*::-webkit-scrollbar-track{background:#1e2223}body::-webkit-scrollbar-thumb,*::-webkit-scrollbar-thumb{background-color:#727173;border-radius:6px;border:3px solid #1e2223}html{background-color:#171a1b;background-image:none}body{background-color:#171a1b;background-image:none;color:#c8d1d8}body a{color:#00c1ff}body a:hover{color:#0087b3}body .header{background-color:#473864}body h1,body h2,body h3,body h4,body h5,body h6{color:#dddad6}body pre>code,body div.formula-code{background:#22272d;color:#adbac7;border:1px solid #333}body form label{color:#777}body form select,body form input,body form textarea,body form button,body form .textarea,body form input[type=text],body form input[type=email],body form input[type=phone],body form input[type=password],body form input[type=number],body form input[type=search]{border:1px solid #1a1a1a;color:#afafaf;background:#242424;transition:background-color .3s cubic-bezier(0.57, 0.21, 0.69, 1.25),transform .3s cubic-bezier(0.57, 0.21, 0.69, 1.25)}body form button,body form input[type=submit],body form input[type=button],body form input[type=reset]{border:1px solid #262626;background:#333}body form ::placeholder{color:inherit;opacity:1}body .post header nav.toc{border-color:#2f363c}body .post .info-bubble{background-color:#25313c;border-color:#384b5c;color:#c8d1d8}body .post .warn-bubble{background-color:#362521;border-color:#563b34;color:inherit}body .post hr{border-color:#2f363c}body .post #article-details{border-color:#2f363c}body .post #article-details #all-categories{border-color:#2f363c}body .post div.related{border-color:#2f363c}body .post .meta,body .post #article-details{color:#789}body .post .intro::first-letter{color:#00c1ff}body .post blockquote{color:#8b949d;border-left-color:#2f363c}body .post .transparency-fix{background-color:#6f8288}body .button-secondary{background-color:#0ca8ff}body .button-secondary:hover{background-color:#008bd8}body a.button__outline{border:3px solid #00c1ff;color:#00c1ff}body a.button__outline:hover{background-color:#00c1ff;color:#fff}body .post div.related div.container div.item .related-meta,body div.archive_list div.container div.item .related-meta{color:#789}body .post div.related h2,body div.archive_list h2{color:#dddad6}body .footer{background-color:#232729;background-image:none}body .footer .contributions #isso-thread label{color:#777}body .footer .contributions #isso-thread select,body .footer .contributions #isso-thread input,body .footer .contributions #isso-thread textarea,body .footer .contributions #isso-thread button,body .footer .contributions #isso-thread .textarea,body .footer .contributions #isso-thread input[type=text],body .footer .contributions #isso-thread input[type=email],body .footer .contributions #isso-thread input[type=phone],body .footer .contributions #isso-thread input[type=password],body .footer .contributions #isso-thread input[type=number],body .footer .contributions #isso-thread input[type=search]{border:1px solid #1a1a1a;color:#afafaf;background:#242424;transition:background-color .3s cubic-bezier(0.57, 0.21, 0.69, 1.25),transform .3s cubic-bezier(0.57, 0.21, 0.69, 1.25)}body .footer .contributions #isso-thread button,body .footer .contributions #isso-thread input[type=submit],body .footer .contributions #isso-thread input[type=button],body .footer .contributions #isso-thread input[type=reset]{border:1px solid #262626;background:#333}body .footer .contributions #isso-thread ::placeholder{color:inherit;opacity:1}body .footer .contributions #isso-thread>h4{color:#8695a4}body .footer .contributions #isso-thread .isso-comment>div.isso-text-wrapper>.isso-comment-header{color:#789}body .footer .contributions #isso-thread .isso-comment>div.isso-text-wrapper>.isso-comment-header .author{color:#8695a4}body .footer .contributions #isso-thread .isso-comment>.isso-text-wrapper blockquote{border-left-color:#3a3e41;background-color:#1d1f20;color:#9d9488}body .footer .contributions #isso-thread .isso-comment>.isso-text-wrapper code{background:#22272d;color:#adbac7}body .footer .contributions #isso-thread .isso-comment>.isso-text-wrapper pre{background:#22272d;color:#adbac7;border:1px solid #333}body .footer .contributions .note-warning{border:1px solid #171a1b;background-color:#1e2223}body .footer .contributions .note-warning .extra{color:#789}body .footer .bottom{background:#171a1b;color:#789;border-top:2px solid #232729;border-bottom:2px solid #232729}body .footer #footer-comments-widget{border-bottom:2px solid #464f52}body div.archive_list:before,body .posts li:before{background:#3a4244}.video .youtube-play-link{box-shadow:0px 0px 5px 0px rgba(200,200,200,.3)}span.link-logo img{-webkit-filter:invert(100%);filter:invert(100%);opacity:.7}a span.link-logo img{filter:invert(84%) sepia(22%) saturate(6251%) hue-rotate(180deg) brightness(110%) contrast(111%);opacity:1}pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!
  Theme: GitHub Dark Dimmed
  Description: Dark dimmed theme as seen on github.com
  Author: github.com
  Maintainer: @Hirse
  Updated: 2021-05-15

  Colors taken from GitHub's CSS
*/.hljs{color:#adbac7;background:#22272e}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#f47067}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#dcbdfb}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-variable{color:#6cb6ff}.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#96d0ff}.hljs-built_in,.hljs-symbol{color:#f69d50}.hljs-code,.hljs-comment,.hljs-formula{color:#768390}.hljs-name,.hljs-quote,.hljs-selector-pseudo,.hljs-selector-tag{color:#8ddb8c}.hljs-subst{color:#adbac7}.hljs-section{color:#316dca;font-weight:700}.hljs-bullet{color:#eac55f}.hljs-emphasis{color:#adbac7;font-style:italic}.hljs-strong{color:#adbac7;font-weight:700}.hljs-addition{color:#b4f1b4;background-color:#1b4721}.hljs-deletion{color:#ffd8d3;background-color:#78191b}}
    </style>
</head>


<body>
   <div class="header">
  <div class="container">
    <div class="inner-container">
      <h1 class="logo"><a href="/">Alex<span class="wide2">andru</span> Nedelcu<span class="wide1" title="strong coffee, java, etc."> ☕️</span></a></h1>
      <nav class="nav-collapse">
        <ul class="noList">
          
          <li class="element first current ">
            <a href="/blog/">Blog</a>
          </li>
          
          <li class="element   ">
            <a href="/wiki/">Wiki</a>
          </li>
          
          <li class="element   ">
            <a href="/links/">Links</a>
          </li>
          
          <li class="element   ">
            <a href="/about/">About</a>
          </li>
          
          <li class="element   last">
            <a href="/subscribe/">Subscribe</a>
          </li>
          
        </ul>
      </nav>
    </div>
  </div>
</div><!-- end .header -->


   <div class="content">
      <div class="container">
         <article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header>
      <h1 class="postTitle" itemprop="headline">
        
        
          
      Asynchronous Programming and Scala
    
        
        
      </h1>
    
    <p class="meta">
      <meta itemscope itemprop="mainEntityOfPage"  itemType="https://schema.org/WebPage" itemid="https://alexn.org/blog/2017/01/30/asynchronous-programming-scala/"/>
      <meta itemprop="datePublished" content="2017-01-30T00:00:00+0000"/>
      
      <time itemprop="dateCreated" datetime="2017-01-30T00:00:00+0000">January 30, 2017</time>
      | <span class="nobr"><span class="time">36</span> minutes</span>
      
      | <a href="/blog/2017/01/30/asynchronous-programming-scala/#isso-thread" class="nobr">Comments</a>
      
    </p>

    
      <div class="hidden" itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
        <meta itemprop="url" content="https://alexn.org/assets/media/articles/nondet.png" />
        
      </div>
      
    

    <div class="hidden" itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
      <meta itemprop="name" content="Alexandru Nedelcu">
      <meta itemprop="url" content="https://alexn.org/about/">
      <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
        <meta itemprop="url" content="https://alexn.org/assets/raw/logo-green.png">
      </div>
    </div>
    <div class="hidden" itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alexandru Nedelcu" />
      <meta itemprop="url" content="https://alexn.org/about/" />
      <meta itemprop="url" content="https://x.com/alexelcu" />
      <meta itemprop="url" content="https://github.com/alexandru" />
      <meta itemprop="url" content="https://www.linkedin.com/in/alexelcu/" />
    </div>

    
    
    
    <nav class="toc">
      <p class="toc-title">Table of Contents:</p>
      <ul>
  <li><a href="#1-introduction">1. Introduction</a></li>
  <li><a href="#2-the-big-illusion">2. The Big Illusion</a></li>
  <li><a href="#3-callback-hell">3. Callback Hell</a>
    <ul>
      <li><a href="#31-sequencing-purgatory-of-side-effects">3.1. Sequencing (Purgatory of Side-effects)</a></li>
      <li><a href="#32-parallelism-limbo-of-nondeterminism">3.2. Parallelism (Limbo of Nondeterminism)</a></li>
      <li><a href="#33-recursivity-wrath-of-stackoverflow">3.3. Recursivity (Wrath of StackOverflow)</a></li>
    </ul>
  </li>
  <li><a href="#4-futures-and-promises">4. Futures and Promises</a>
    <ul>
      <li><a href="#41-sequencing">4.1. Sequencing</a></li>
      <li><a href="#42-parallelism">4.2. Parallelism</a></li>
      <li><a href="#43-recursivity">4.3. Recursivity</a></li>
      <li><a href="#44-performance-considerations">4.4. Performance Considerations</a></li>
    </ul>
  </li>
  <li><a href="#5-task-scalas-io-monad">5. Task, Scala’s IO Monad</a>
    <ul>
      <li><a href="#51-sequencing">5.1. Sequencing</a></li>
      <li><a href="#52-parallelism">5.2. Parallelism</a></li>
      <li><a href="#53-recursivity">5.3. Recursivity</a></li>
    </ul>
  </li>
  <li><a href="#6-functional-programming-and-type-classes">6. Functional Programming and Type-classes</a>
    <ul>
      <li><a href="#61-monad-sequencing-and-recursivity">6.1. Monad (Sequencing and Recursivity)</a></li>
      <li><a href="#62-applicative-parallelism">6.2. Applicative (Parallelism)</a></li>
      <li><a href="#63-can-we-define-a-type-class-for-async-evaluation">6.3. Can We Define a Type-class for Async Evaluation?</a></li>
    </ul>
  </li>
  <li><a href="#7-picking-the-right-tool">7. Picking the Right Tool</a></li>
</ul>
    </nav>
    </header>

  <div id="content" itemprop="articleBody">
    <p class="intro">Asynchrony is everywhere and it subsumes concurrency. This article explains what asynchronous processing is and its challenges.</p>
      <h2 id="1-introduction">
        
        
          1. Introduction <a href="#1-introduction" class="anchor">#</a>
        
        
      </h2>
    

<p>As a concept it is more general than <em>multithreading</em>, although some
people confuse the two. If you’re looking for a relationship, you
could say:</p>

<pre><code class="language-scala">Multithreading &lt;: Asynchrony
</code></pre>

<p>We can represent asynchronous computations with a type:</p>

<pre><code class="language-scala">type Async[A] = (Try[A] =&gt; Unit) =&gt; Unit
</code></pre>

<p>If it looks ugly with those <code>Unit</code> return types, that’s because
asynchrony is ugly. An asynchronous computation is any task, thread,
process, node somewhere on the network that:</p>

<ol>
  <li>executes outside of your program’s main flow or from the point of
view of the caller, it doesn’t execute on the current call-stack</li>
  <li>receives a callback that will get called once the result is
finished processing</li>
  <li>it provides no guarantee about when the result is signaled, no
guarantee that a result will be signaled at all</li>
</ol>

<p>It’s important to note asynchrony subsumes <em>concurrency</em>, but not
necessarily <em>multithreading</em>. Remember that in Javascript the majority
of all I/O actions (input or output) are asynchronous and even heavy
business logic is made asynchronous (with <code>setTimeout</code> based scheduling)
in order to keep the interface responsive. But no kernel-level
multithreading is involved, Javascript being an N:1 multithreaded
platform.</p>

<p>Introducing asynchrony into your program means you’ll have concurrency
problems because you never know when asynchronous computations will be
finished, so <em>composing</em> the results of multiple asynchronous
computations running at the same time means you have to do
synchronization, as you can no longer rely on ordering. And not
relying on an order is a recipe for <em>nondeterminism</em>.</p>

<p class="info-bubble">
<a href="https://en.wikipedia.org/wiki/Nondeterministic_algorithm">Wikipedia says</a>:
a <em>nondeterministic</em> algorithm is an algorithm that, even for the same
input, can exhibit different behaviors on different runs, as opposed
to a <em>deterministic</em> algorithm … A <em>concurrent</em> algorithm can perform
differently on different runs due to a race condition.
</p>

<figure>
  <img src="/assets/media/articles/nondet.png" width="775" height="458" decoding="async" />
</figure>

<p>The astute reader could notice that the type in question can be seen <em>everywhere</em>,
with some modifications depending on use-case and contract:</p>

<ul>
  <li>in the <a href="https://en.wikipedia.org/wiki/Observer_pattern">Observer pattern</a>
from the <a href="https://en.wikipedia.org/wiki/Design_Patterns">Gang of Four</a></li>
  <li>in Scala’s <a href="http://www.scala-lang.org/api/current/scala/concurrent/Future.html">Future</a>,
which is defined by its abstract <code>onComplete</code> method</li>
  <li>in Java’s <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html#submit-java.util.concurrent.Callable-">ExecutorService.submit(Callable)</a></li>
  <li>in Javascript’s <a href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener">EventTarget.addEventListener</a></li>
  <li>in <a href="http://akka.io/">Akka</a> actors, although there the given callback
is replaced by the <code>sender()</code> reference</li>
  <li>in the Monix <a href="https://github.com/monix/monix/blob/v2.2.1/monix-eval/shared/src/main/scala/monix/eval/Task.scala#L1253">Task.Async</a> definition</li>
  <li>in the Monix <a href="https://monix.io/api/2.2/monix/reactive/Observable.html">Observable</a>
and <a href="https://monix.io/api/2.2/monix/reactive/Observer.html">Observer</a> pair</li>
  <li>in the <a href="http://www.reactive-streams.org/reactive-streams-1.0.0-javadoc/">Reactive Streams</a> specification</li>
</ul>

<p>What do all of these abstractions have in common? They provide ways to
deal with asynchrony, some more successful than others.</p>
      <h2 id="2-the-big-illusion">
        
        
          2. The Big Illusion <a href="#2-the-big-illusion" class="anchor">#</a>
        
        
      </h2>
    

<p>We like to pretend that we can describe functions that can convert
asynchronous results to synchronous ones:</p>

<pre><code class="language-scala">def await[A](fa: Async[A]): A
</code></pre>

<p>Fact of the matter is that we can’t pretend that asynchronous
processes are equivalent with normal functions. If you need a lesson
in history for why we can’t pretend that, you only need to take a look
at why CORBA failed.</p>

<p>With asynchronous processes we have the following very common
<a href="https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing">fallacies of distributed computing</a>:</p>

<ol>
  <li>The network is reliable</li>
  <li>Latency is zero</li>
  <li>Bandwidth is infinite</li>
  <li>The network is secure</li>
  <li>Topology doesn’t change</li>
  <li>There is one administrator</li>
  <li>Transport cost is zero</li>
  <li>The network is homogeneous</li>
</ol>

<p>None of them are true of course. Which means code gets written with
little error handling for network failures, ignorance of network
latency or packet loss, ignorance of bandwidth limits and in general
ignorance of the ensuing nondeterminism.</p>

<p>People have tried to cope with this by:</p>

<ul>
  <li>callbacks, callbacks everywhere, equivalent to basically ignoring
the problem, as it happens in Javascript, which leads to the well
known effect of <em>callback hell</em>, paid for with the sweat and blood
of programmers that constantly imagine having chosen a different
life path</li>
  <li>blocking threads, on top of
<a href="https://en.wikipedia.org/wiki/Thread_(computing)#1:1_.28kernel-level_threading.29">1:1 (kernel-level) multithreading</a>
platforms</li>
  <li><a href="https://en.wikipedia.org/wiki/Continuation">first-class continuations</a>,
implemented for example by Scheme in
<a href="https://en.wikipedia.org/wiki/Call-with-current-continuation">call/cc</a>,
being the ability to save the execution state at any point and
return to that point at a later point in the program</li>
  <li>The <code>async</code> / <code>await</code> language extension from C#, also implemented in
the <a href="https://github.com/scala/async">scala-async</a> library and in the
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">latest ECMAScript</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Green_threads">Green threads</a>
managed by the runtime, possibly in combination with
<a href="https://en.wikipedia.org/wiki/Thread_(computing)#M:N_.28hybrid_threading.29">M:N multithreading</a>,
to simulate blocking for asynchronous actions; examples including
Golang but also Haskell</li>
  <li>The <a href="https://en.wikipedia.org/wiki/Actor_model">actor model</a> as implemented in Erlang or Akka,
or <a href="https://en.wikipedia.org/wiki/Communicating_sequential_processes">CSP</a> such as
in <a href="https://github.com/clojure/core.async">Clojure’s core.async</a> or in Golang</li>
  <li>Monads being used for ordering and composition, such as Haskell’s
<a href="https://hackage.haskell.org/package/async-2.1.1/docs/Control-Concurrent-Async.html">Async</a> type
in combination with the <a href="https://wiki.haskell.org/IO_inside">IO</a> type, or
<a href="https://docs.microsoft.com/en-us/dotnet/articles/fsharp/language-reference/asynchronous-workflows">F# asynchronous workflows</a>,
or <a href="http://docs.scala-lang.org/overviews/core/futures.html">Scala’s Futures and Promises</a>,
or the <a href="https://monix.io/docs/2x/eval/task.html">Monix Task</a>
or the <a href="https://github.com/scalaz/scalaz/blob/scalaz-seven/concurrent/src/main/scala/scalaz/concurrent/Task.scala">Scalaz Task</a>,
etc, etc.</li>
</ul>

<p>If there are so many solutions, that’s because none of them is
suitable as a general purpose mechanism for dealing with asynchrony.
The <a href="https://en.wikipedia.org/wiki/No_Silver_Bullet">no silver bullet</a>
dilemma is relevant here, with memory management and concurrency being
the biggest problems that we face as software developers.</p>

<p class="info-bubble">
<strong>WARNING - personal opinion and rant:</strong> People like to boast about M:N
platforms like Golang, however I prefer 1:1 multithreaded platforms,
like the JVM or dotNET.
<br /><br />
Because you can build M:N multithreading on top of 1:1 given enough
expressiveness in the programming language (e.g. Scala’s Futures and
Promises, Task, Clojure’s core.async, etc), but if that M:N runtime starts being
unsuitable for your usecase, then you can’t fix it or replace it
without replacing the platform. And yes, most M:N platforms are broken
in one way or another.
<br /><br />
Indeed learning about all the possible solutions and making choices is
freaking painful, but it is much less painful than making uninformed
choices, with the TOOWTDI and “worse is better” mentalities being in
this case actively harmful. People complaining about the difficulty of
learning a new and expressive language like Scala or Haskell are
missing the point, because if they have to deal with concurrency, then
learning a new programming language is going to be the least of their
problems. I know people that have quit the software industry because
of the shift to concurrency.
</p>
      <h2 id="3-callback-hell">
        
        
          3. Callback Hell <a href="#3-callback-hell" class="anchor">#</a>
        
        
      </h2>
    

<p>Let’s build an artificial example made to illustrate our challenges.
Say we need to initiate two asynchronous processes and combine their
result.</p>

<p>First let’s define a function that executes stuff asynchronously:</p>

<pre><code class="language-scala">import scala.concurrent.ExecutionContext.global

type Async[A] = (A =&gt; Unit) =&gt; Unit

def timesTwo(n: Int): Async[Int] =
  onFinish =&gt; {
    global.execute(new Runnable {
      def run(): Unit = {
        val result = n * 2
        onFinish(result)
      }
    })
  }

// Usage
timesTwo(20) { result =&gt; println(s"Result: $result") }
//=&gt; Result: 40
</code></pre>
      <h3 id="31-sequencing-purgatory-of-side-effects">
        
        
          3.1. Sequencing (Purgatory of Side-effects) <a href="#31-sequencing-purgatory-of-side-effects" class="anchor">#</a>
        
        
      </h3>
    

<p>Let’s combine two asynchronous results, with the execution happening
one after another, in a neat sequence:</p>

<pre><code class="language-scala">def timesFour(n: Int): Async[Int] =
  onFinish =&gt; {
    timesTwo(n) { a =&gt;
      timesTwo(n) { b =&gt;
        // Combining the two results
        onFinish(a + b)
      }
    }
  }

// Usage
timesFour(20) { result =&gt; println(s"Result: $result") }
//=&gt; Result: 80
</code></pre>

<p>Looks simple now, but we are only combining two results, one after another.</p>

<p>The big problem however is that <em>asynchrony infects everything it touches</em>.
Let’s assume for  the sake of argument that we start with a pure function:</p>

<pre><code class="language-scala">def timesFour(n: Int): Int = n * 4
</code></pre>

<p>But then your enterprise architect, after hearing about these Enterprise JavaBeans and
a lap dance, decides that you should depend on this asynchronous <code>timesTwo</code>
function. And now our <code>timesFour</code> implementation changes from a pure mathematical
function to a side-effectful one and we have no choice in the matter.
And without a well grown <code>Async</code> type, we are forced to deal with side-effectful
callbacks for the whole pipeline. And blocking for the result won’t help,
as you’re just hiding the problem, see <a href="#2-the-big-illusion">section 2</a> for why.</p>

<p>But wait, things are about to get worse 😷</p>
      <h3 id="32-parallelism-limbo-of-nondeterminism">
        
        
          3.2. Parallelism (Limbo of Nondeterminism) <a href="#32-parallelism-limbo-of-nondeterminism" class="anchor">#</a>
        
        
      </h3>
    

<p>The second call we made above is not dependent on the first call,
therefore it can run in parallel. On the JVM we can run CPU-bound
tasks in parallel, but this is relevant for Javascript as well, as we
could be making Ajax requests or talking with web workers.</p>

<p>Unfortunately here things can get a little complicated. First of all
the naive way to do it is terribly wrong:</p>

<pre><code class="language-scala">// REALLY BAD SAMPLE

def timesFourInParallel(n: Int): Async[Int] =
  onFinish =&gt; {
    var cacheA = 0

    timesTwo(n) { a =&gt; cacheA = a }

    timesTwo(n) { b =&gt;
      // Combining the two results
      onFinish(cacheA + b)
    }
  }

timesFourInParallel(20) { result =&gt; println(s"Result: $result") }
//=&gt; Result: 80

timesFourInParallel(20) { result =&gt; println(s"Result: $result") }
//=&gt; Result: 40
</code></pre>

<p>This right here is an example showing <em>nondeterminism</em> in action. We
get <em>no ordering guarantees</em> about which one finishes first, so if we
want parallel processing, we need to model a mini state machine for
doing synchronization.</p>

<p>First, we define our ADT describing the state-machine:</p>

<pre><code class="language-scala">// Defines the state machine
sealed trait State
// Initial state
case object Start extends State
// We got a B, waiting for an A
final case class WaitForA(b: Int) extends State
// We got a A, waiting for a B
final case class WaitForB(a: Int) extends State
</code></pre>

<p>And then we can evolve this state machine asynchronously:</p>

<pre><code class="language-scala">// BAD SAMPLE FOR THE JVM (only works for Javascript)

def timesFourInParallel(n: Int): Async[Int] = {
  onFinish =&gt; {
    var state: State = Start

    timesTwo(n) { a =&gt;
      state match {
        case Start =&gt;
          state = WaitForB(a)
        case WaitForA(b) =&gt;
          onFinish(a + b)
        case WaitForB(_) =&gt;
          // Can't be caught b/c async, hopefully it gets reported
          throw new IllegalStateException(state.toString)
      }
    }

    timesTwo(n) { b =&gt;
      state match {
        case Start =&gt;
          state = WaitForA(b)
        case WaitForB(a) =&gt;
          onFinish(a + b)
        case WaitForA(_) =&gt;
          // Can't be caught b/c async, hopefully it gets reported
          throw new IllegalStateException(state.toString)
      }
    }
  }
}
</code></pre>

<p>To better visualize what we’re dealing with, here’s the state machine:</p>

<figure>
  <img src="/assets/media/articles/callback-hell-stm.png" width="642" height="670" decoding="async" />
</figure>

<p>But wait, we aren’t over because the JVM has true 1:1 multi-threading, which means
we get to enjoy <em>shared memory concurrency</em> and thus access to that <code>state</code> has to
be synchronized.</p>

<p>One solution is to use <code>synchronized</code> blocks, also called <em>intrinsic locks</em>:</p>

<pre><code class="language-scala">// We need a common reference to act as our monitor
val lock = new AnyRef
var state: State = Start

timesTwo(n) { a =&gt;
  lock.synchronized {
    state match {
      case Start =&gt;
        state = WaitForB(a)
      case WaitForA(b) =&gt;
        onFinish(a + b)
      case WaitForB(_) =&gt;
        // Can't be caught b/c async, hopefully it gets reported
        throw new IllegalStateException(state.toString)
    }
  }
}

//...
</code></pre>

<p>Such high-level locks protect resources (such as our <code>state</code>) from
being accessed in parallel by multiple threads. But I personally
prefer to avoid high-level locks because the kernel’s scheduler can
freeze any thread for any reason, including threads that hold locks,
freezing a thread holding a lock means that other threads will be
unable to make progress and if you want to guarantee constant progress
(e.g. soft real-time characteristics), then
<a href="https://en.wikipedia.org/wiki/Non-blocking_algorithm">non-blocking</a>
logic is preferred when possible.</p>

<p>So an alternative is to use an
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicReference.html">AtomicReference</a>,
which is perfect for this case:</p>

<pre><code class="language-scala">// CORRECT VERSION FOR JVM

import scala.annotation.tailrec
import java.util.concurrent.atomic.AtomicReference

def timesFourInParallel(n: Int): Async[Int] = {
  onFinish =&gt; {
    val state = new AtomicReference[State](Start)

    @tailrec def onValueA(a: Int): Unit =
      state.get match {
        case Start =&gt;
          if (!state.compareAndSet(Start, WaitForB(a)))
            onValueA(a) // retry
        case WaitForA(b) =&gt;
          onFinish(a + b)
        case WaitForB(_) =&gt;
          // Can't be caught b/c async, hopefully it gets reported
          throw new IllegalStateException(state.toString)
      }

    timesTwo(n)(onValueA)

    @tailrec def onValueB(b: Int): Unit =
      state.get match {
        case Start =&gt;
          if (!state.compareAndSet(Start, WaitForA(b)))
            onValueB(b) // retry
        case WaitForB(a) =&gt;
          onFinish(a + b)
        case WaitForA(_) =&gt;
          // Can't be caught b/c async, hopefully it gets reported
          throw new IllegalStateException(state.toString)
      }

    timesTwo(n)(onValueB)
  }
}
</code></pre>

<p class="info-bubble">
<strong>PRO-TIP:</strong> if you want code that cross-compiles to Javascript / Scala.js,
along with performance tweaks and cool utilities for manipulating atomic references,
try the <a href="https://monix.io/docs/2x/execution/atomic.html">Atomic</a> type
from <a href="https://monix.io/">Monix</a>.
</p>

<p>Are you getting pumped? Let’s take it up a notch 😝</p>
      <h3 id="33-recursivity-wrath-of-stackoverflow">
        
        
          3.3. Recursivity (Wrath of StackOverflow) <a href="#33-recursivity-wrath-of-stackoverflow" class="anchor">#</a>
        
        
      </h3>
    

<p>What if I were to tell you that the above <code>onFinish</code> call is
stack-unsafe and if you aren’t going to force an <em>asynchronous
boundary</em> when calling it, then your program can blow up
with a <code>StackOverflowError</code>?</p>

<p>You shouldn’t take my word for it. Let’s first have some fun and
define the above operation in a generic way:</p>

<pre><code class="language-scala">import scala.annotation.tailrec
import java.util.concurrent.atomic.AtomicReference

type Async[+A] = (A =&gt; Unit) =&gt; Unit

def mapBoth[A,B,R](fa: Async[A], fb: Async[B])(f: (A,B) =&gt; R): Async[R] = {
  // Defines the state machine
  sealed trait State[+A,+B]
  // Initial state
  case object Start extends State[Nothing, Nothing]
  // We got a B, waiting for an A
  final case class WaitForA[+B](b: B) extends State[Nothing,B]
  // We got a A, waiting for a B
  final case class WaitForB[+A](a: A) extends State[A,Nothing]

  onFinish =&gt; {
    val state = new AtomicReference[State[A,B]](Start)

    @tailrec def onValueA(a: A): Unit =
      state.get match {
        case Start =&gt;
          if (!state.compareAndSet(Start, WaitForB(a)))
            onValueA(a) // retry
        case WaitForA(b) =&gt;
          onFinish(f(a,b))
        case WaitForB(_) =&gt;
          // Can't be caught b/c async, hopefully it gets reported
          throw new IllegalStateException(state.toString)
      }

    @tailrec def onValueB(b: B): Unit =
      state.get match {
        case Start =&gt;
          if (!state.compareAndSet(Start, WaitForA(b)))
            onValueB(b) // retry
        case WaitForB(a) =&gt;
          onFinish(f(a,b))
        case WaitForA(_) =&gt;
          // Can't be caught b/c async, hopefully it gets reported
          throw new IllegalStateException(state.toString)
      }

    fa(onValueA)
    fb(onValueB)
  }
}
</code></pre>

<p>And now we can define an operation similar to Scala’s <code>Future.sequence</code>,
because our will is strong and our courage immensurable 😇</p>

<pre><code class="language-scala">def sequence[A](list: List[Async[A]]): Async[List[A]] = {
  @tailrec def loop(list: List[Async[A]], acc: Async[List[A]]): Async[List[A]] =
    list match {
      case Nil =&gt;
        onFinish =&gt; acc(r =&gt; onFinish(r.reverse))
      case x :: xs =&gt;
        val update = mapBoth(x, acc)(_ :: _)
        loop(xs, update)
    }

  val empty: Async[List[A]] = _(Nil)
  loop(list, empty)
}

// Invocation
sequence(List(timesTwo(10), timesTwo(20), timesTwo(30))) { r =&gt;
  println(s"Result: $r")
}
//=&gt; Result: List(20, 40, 60)
</code></pre>

<p>Oh, you really think we are done?</p>

<pre><code class="language-scala">val list = 0.until(10000).map(timesTwo).toList
sequence(list)(r =&gt; println(s"Sum: ${r.sum}"))
</code></pre>

<p>Behold the glorious memory error that will probably crash your program in production,
being considered a fatal error that Scala’s <code>NonFatal</code> does not catch:</p>

<pre><code>java.lang.StackOverflowError
  at java.util.concurrent.ForkJoinPool.externalPush(ForkJoinPool.java:2414)
  at java.util.concurrent.ForkJoinPool.execute(ForkJoinPool.java:2630)
  at scala.concurrent.impl.ExecutionContextImpl$$anon$3.execute(ExecutionContextImpl.scala:131)
  at scala.concurrent.impl.ExecutionContextImpl.execute(ExecutionContextImpl.scala:20)
  at .$anonfun$timesTwo$1(&lt;pastie&gt;:27)
  at .$anonfun$timesTwo$1$adapted(&lt;pastie&gt;:26)
  at .$anonfun$mapBoth$1(&lt;pastie&gt;:66)
  at .$anonfun$mapBoth$1$adapted(&lt;pastie&gt;:40)
  at .$anonfun$mapBoth$1(&lt;pastie&gt;:67)
  at .$anonfun$mapBoth$1$adapted(&lt;pastie&gt;:40)
  at .$anonfun$mapBoth$1(&lt;pastie&gt;:67)
  at .$anonfun$mapBoth$1$adapted(&lt;pastie&gt;:40)
  at .$anonfun$mapBoth$1(&lt;pastie&gt;:67)
</code></pre>

<p>As I said, that <code>onFinish</code> call being made without a <em>forced async
boundary</em> can lead to a stack-overflow error. On top of Javascript
this can be solved by scheduling it with <code>setTimeout</code> and on top of
the JVM you need a thread-pool or a Scala <code>ExecutionContext</code>.</p>

<p>Are you feeling the fire yet? 🔥</p>
      <h2 id="4-futures-and-promises">
        
        
          4. Futures and Promises <a href="#4-futures-and-promises" class="anchor">#</a>
        
        
      </h2>
    

<p>The <code>scala.concurrent.Future</code> describes strictly evaluated
asynchronous computations, being similar to our <code>Async</code> type used
above.</p>

<p class="info-bubble">
<a href="https://en.wikipedia.org/wiki/Futures_and_promises">Wikipedia says</a>:
Future and Promise are constructs used for synchronizing program
execution in some concurrent programming languages. They describe an
object that acts as a proxy for a result that is initially unknown,
usually because the computation of its value is yet incomplete.
</p>

<p class="info-bubble">
<strong>Author’s Rant:</strong> The <code>docs.scala-lang.org</code> article on
<a href="http://docs.scala-lang.org/overviews/core/futures.html">Futures and Promises</a> currently
says that “<em>Futures provide a way to reason about performing many
operations in parallel– in an efficient and non-blocking way</em>”, but
that is misleading, a source of confusion.
<br /><br />
The <code>Future</code> type describes <em>asynchrony</em> and not parallelism. Yes, you
can do things in parallel with it, but it’s not meant only for
parallelism (async != parallelism) and for people looking into ways to
use their CPU capacity to its fullest, working with <code>Future</code> can prove
to be expensive and unwise, because in certain cases it has performance
issues, see <a href="#44-performance-considerations">section 4.4</a>.
</p>

<p>The <code>Future</code> is an interface defined by 2 primary operations, along with
many combinators defined based on those primary operations:</p>

<pre><code class="language-scala">import scala.util.Try
import scala.concurrent.ExecutionContext

trait Future[+T] {
  // abstract
  def value: Option[Try[T]]

  // abstract
  def onComplete(f: Try[T] =&gt; Unit)(implicit ec: ExecutionContext): Unit

  // Transforms values
  def map[U](f: T =&gt; U)(implicit ec: ExecutionContext): Future[U] = ???
  // Sequencing ;-)
  def flatMap[U](f: T =&gt; Future[U])(implicit ec: ExecutionContext): Future[U] = ???
  // ...
}
</code></pre>

<p>The properties of <code>Future</code>:</p>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Eager_evaluation">Eagerly evaluated</a>
(strict and not lazy), meaning that when the caller of a function
receives a <code>Future</code> reference, whatever asynchronous process that
should complete it has probably started already.</li>
  <li><a href="https://en.wikipedia.org/wiki/Memoization">Memoized</a> (cached),
since being eagerly evaluated means that it behaves like a normal
value instead of a function and the final result needs to be
available to all listeners. The purpose of the <code>value</code> property is
to return that memoized result or <code>None</code> if it isn’t complete
yet. Goes without saying that calling its <code>def value</code> yields a
non-deterministic result.</li>
  <li>Streams a single result and it shows because of the memoization
applied. So when listeners are registered for completion, they’ll
only get called once at most.</li>
</ul>

<p>Explanatory notes about the <code>ExecutionContext</code>:</p>

<ul>
  <li>The <code>ExecutionContext</code> manages asynchronous execution and although
you can view it as a thread-pool, it’s not necessarily a thread-pool
(because async != multithreading or parallelism).</li>
  <li>The <code>onComplete</code> is basically our <code>Async</code> type defined above,
however it takes an <code>ExecutionContext</code> because all completion
callbacks need to be called asynchronously.</li>
  <li>All combinators and utilities are built on top of <code>onComplete</code>,
therefore all combinators and utilities must also take an
<code>ExecutionContext</code> parameter.</li>
</ul>

<p>If you don’t understand why that <code>ExecutionContext</code> is needed in all
those signatures, go back and re-read <a href="#33-recursivity-wrath-of-stackoverflow">section 3.3</a> and don’t
come back until you do.</p>
      <h3 id="41-sequencing">
        
        
          4.1. Sequencing <a href="#41-sequencing" class="anchor">#</a>
        
        
      </h3>
    

<p>Let’s redefine our function from <a href="#3-callback-hell">section 3</a> in terms of <code>Future</code>:</p>

<pre><code class="language-scala">import scala.concurrent.{Future, ExecutionContext}

def timesTwo(n: Int)(implicit ec: ExecutionContext): Future[Int] =
  Future(n * 2)

// Usage
{
  import scala.concurrent.ExecutionContext.Implicits.global

  timesTwo(20).onComplete { result =&gt; println(s"Result: $result") }
  //=&gt; Result: Success(40)
}
</code></pre>

<p>Easy enough, the <code>Future.apply</code> builder executes the given computation
on the given <code>ExecutionContext</code>. So on the JVM, assuming the <code>global</code>
execution context, it’s going to run on a different thread.</p>

<p>Now to do sequencing like in <a href="#31-sequencing-purgatory-of-side-effects">section 3.1</a>:</p>

<pre><code class="language-scala">def timesFour(n: Int)(implicit ec: ExecutionContext): Future[Int] =
  for (a &lt;- timesTwo(n); b &lt;- timesTwo(n)) yield a + b

// Usage
{
  import scala.concurrent.ExecutionContext.Implicits.global

  timesFour(20).onComplete { result =&gt; println(s"Result: $result") }
  //=&gt; Result: Success(80)
}
</code></pre>

<p>Easy enough. That “<em>for comprehension</em>” magic right there is
translated to nothing more than calls to <code>flatMap</code> and <code>map</code>, being
literally equivalent with:</p>

<pre><code class="language-scala">def timesFour(n: Int)(implicit ec: ExecutionContext): Future[Int] =
  timesTwo(n).flatMap { a =&gt;
    timesTwo(n).map { b =&gt;
      a + b
    }
  }
</code></pre>

<p>And if you import <a href="https://github.com/scala/async">scala-async</a> in
your project, then you can do it like:</p>

<pre><code class="language-scala">import scala.async.Async.{async, await}

def timesFour(n: Int)(implicit ec: ExecutionContext): Future[Int] =
  async {
    val a = await(timesTwo(a))
    val b = await(timesTwo(b))
    a + b
  }
</code></pre>

<p>The <code>scala-async</code> library is powered by macros and will translate your
code to something equivalent to <code>flatMap</code> and <code>map</code> calls. So in other
words <code>await</code> does not block threads, even though it gives the
illusion that it does.</p>

<p>This looks great actually, unfortunately it has many limitations.  The
library <em>cannot rewrite</em> your code in case the <code>await</code> is inside an
anonymous function and unfortunately Scala code is usually full of
such expressions. This does not work:</p>

<pre><code class="language-scala">// BAD SAMPLE
def sum(list: List[Future[Int]])(implicit ec; ExecutionContext): Future[Int] =
  async {
    var sum = 0
    // Nope, not going to work because "for" is translated to "foreach"
    for (f &lt;- list) {
      sum += await(f)
    }
  }
</code></pre>

<p>This approach gives the illusion of having <em>first-class
continuations</em>, but these continuations are unfortunately not first
class, being just a compiler-managed rewrite of the code. And yes,
this restriction applies to C# and ECMAScript as well. Which is a
pity, because it means <code>async</code> code will not be heavy on FP.</p>

<p>Remember my rant from above about the no silver bullet? 😞</p>
      <h3 id="42-parallelism">
        
        
          4.2. Parallelism <a href="#42-parallelism" class="anchor">#</a>
        
        
      </h3>
    

<p>Just as in <a href="#32-parallelism-limbo-of-nondeterminism">section 3.2</a> those two function calls are
independent of each other, which means that we can call them in
parallel. With <code>Future</code> this is easier, although its evaluation
semantics can be a little confusing for beginners:</p>

<pre><code class="language-scala">def timesFourInParallel(n: Int)(implicit ec: ExecutionContext): Future[Int] = {
  // Future is eagerly evaluated, so this will trigger the
  // execution of both before the composition happens
  val fa = timesTwo(n)
  val fb = timesTwo(n)

  for (a &lt;- fa; b &lt;- fb) yield a + b
  // fa.flatMap(a =&gt; fb.map(b =&gt; a + b))
}
</code></pre>

<p>It can be a little confusing and it catches beginners
off-guard. Because of its execution model, in order to execute things
in parallel, you simply have to initialize those future references
before the composition happens.</p>

<p>An alternative would be to use <code>Future.sequence</code>, which works for
arbitrary collections:</p>

<pre><code class="language-scala">def timesFourInParallel(n: Int)(implicit ec: ExecutionContext): Future[Int] =
  Future.sequence(timesTwo(n) :: timesTwo(n) :: Nil).map(_.sum)
</code></pre>

<p>This too can catch beginners by surprise, because those futures are
going to be executed in parallel only if the collection given to
<code>sequence</code> is strict (not like Scala’s <code>Stream</code> or some <code>Iterator</code>). And
the name is sort of a misnomer obviously.</p>
      <h3 id="43-recursivity">
        
        
          4.3. Recursivity <a href="#43-recursivity" class="anchor">#</a>
        
        
      </h3>
    

<p>The <code>Future</code> type is entirely safe for recursive operations (because
of the reliance on the <code>ExecutionContext</code> for executing callbacks). So
retrying the sample in <a href="#33-recursivity-wrath-of-stackoverflow">section 3.3</a>:</p>

<pre><code class="language-scala">def mapBoth[A,B,R](fa: Future[A], fb: Future[B])(f: (A,B) =&gt; R)
  (implicit ec: ExecutionContext): Future[R] = {

  for (a &lt;- fa; b &lt;- fb) yield f(a,b)
}

def sequence[A](list: List[Future[A]])
  (implicit ec: ExecutionContext): Future[List[A]] = {

  val seed = Future.successful(List.empty[A])
  list.foldLeft(seed)((acc,f) =&gt; for (l &lt;- acc; a &lt;- f) yield a :: l)
    .map(_.reverse)
}

// Invocation
{
  import scala.concurrent.ExecutionContext.Implicits.global

  sequence(List(timesTwo(10), timesTwo(20), timesTwo(30))).foreach(println)
  // =&gt; List(20, 40, 60)
}
</code></pre>

<p>And this time we get no <code>StackOverflowError</code>:</p>

<pre><code class="language-scala">val list = 0.until(10000).map(timesTwo).toList
sequence(list).foreach(r =&gt; println(s"Sum: ${r.sum}"))
//=&gt; Sum: 99990000
</code></pre>
      <h3 id="44-performance-considerations">
        
        
          4.4. Performance Considerations <a href="#44-performance-considerations" class="anchor">#</a>
        
        
      </h3>
    

<p>The trouble with <code>Future</code> is that each call to <code>onComplete</code> will use
an <code>ExecutionContext</code> for execution and in general this means that a
<code>Runnable</code> is sent in a thread-pool, thus forking a (logical) thread.
If you have CPU-bounded tasks, this implementation detail is actually
a disaster for performance because jumping threads means
<a href="https://en.wikipedia.org/wiki/Context_switch">context switches</a>,
along with the CPU
<a href="https://en.wikipedia.org/wiki/Locality_of_reference">cache locality</a>
being destroyed. Of course, the implementation does have certain optimizations,
like the <code>flatMap</code> implementation using an internal execution context that’s
trampolined, in order to avoid forks when chaining those internal
callbacks, but it’s not enough and benchmarking doesn’t lie.</p>

<p>Also due to it being memoized means that upon completion the
implementation is forced to execute at least one
<code>AtomicReference.compareAndSet</code> per producer, plus one <code>compareAndSet</code>
call per listener registered before the <code>Future</code> is complete. And such
calls are quite expensive, all because we need memoization that plays
well with multithreading.</p>

<p>In other words if you want to exploit your CPU to its fullest for CPU-bound
tasks, then working with futures and promises is not such a good idea.</p>

<p>If you want to see how Scala’s <code>Future</code> implementation compares with
<code>Task</code>, see the following
<a href="https://github.com/rossabaker/benchmarks/pull/4">recent benchmark</a>:</p>

<pre><code>[info] Benchmark                   (size)   Mode  Cnt     Score     Error  Units
[info] FlatMap.fs2Apply             10000  thrpt   20   291.459 ±   6.321  ops/s
[info] FlatMap.fs2Delay             10000  thrpt   20  2606.864 ±  26.442  ops/s
[info] FlatMap.fs2Now               10000  thrpt   20  3867.300 ± 541.241  ops/s
[info] FlatMap.futureApply          10000  thrpt   20   212.691 ±   9.508  ops/s
[info] FlatMap.futureSuccessful     10000  thrpt   20   418.736 ±  29.121  ops/s
[info] FlatMap.futureTrampolineEc   10000  thrpt   20   423.647 ±   8.543  ops/s
[info] FlatMap.monixApply           10000  thrpt   20   399.916 ±  15.858  ops/s
[info] FlatMap.monixDelay           10000  thrpt   20  4994.156 ±  40.014  ops/s
[info] FlatMap.monixNow             10000  thrpt   20  6253.182 ±  53.388  ops/s
[info] FlatMap.scalazApply          10000  thrpt   20   188.387 ±   2.989  ops/s
[info] FlatMap.scalazDelay          10000  thrpt   20  1794.680 ±  24.173  ops/s
[info] FlatMap.scalazNow            10000  thrpt   20  2041.300 ± 128.729  ops/s
</code></pre>

<p>As you can see the <a href="https://monix.io/docs/2x/eval/task.html">Monix Task</a> destroys
Scala’s <code>Future</code> for CPU-bound tasks.</p>

<p class="info-bubble">
<strong>NOTE:</strong> this benchmark is limited, there are still use-cases where
usage of <code>Future</code> is faster (e.g. the Monix <a href="https://monix.io/docs/2x/reactive/observers.html">Observer</a>
uses <code>Future</code> for back-pressure for a good reason) and performance is
often not relevant, like when doing I/O, in which case throughput
will not be CPU-bound.
</p>
      <h2 id="5-task-scalas-io-monad">
        
        
          5. Task, Scala’s IO Monad <a href="#5-task-scalas-io-monad" class="anchor">#</a>
        
        
      </h2>
    

<p><code>Task</code> is a data type for controlling possibly lazy &amp; asynchronous computations,
useful for controlling side-effects, avoiding nondeterminism and callback-hell.</p>

<p>The <a href="https://monix.io/">Monix</a> library provides a very sophisticated
<a href="https://monix.io/docs/2x/eval/task.html">Task</a> implementation, inspired by the
<a href="https://github.com/scalaz/scalaz/blob/scalaz-seven/concurrent/src/main/scala/scalaz/concurrent/Task.scala">Task in Scalaz</a>.
Same concept, different implementation.</p>

<p class="info-bubble">
The <code>Task</code> type is also inspired by <a href="https://wiki.haskell.org/IO_inside">Haskell’s IO monad</a>,
being in this author’s opinion the true <code>IO</code> type for Scala.
<br /><br />
This is a matter of debate, as Scalaz also exposes a separate <code>IO</code> type
that only deals with synchronous execution. The Scalaz <code>IO</code> is not async, which
means that it doesn’t tell the whole story, because on top of the JVM you need
to represent async computations somehow. In Haskell on the other hand you have
the <code>Async</code> type which is converted to <code>IO</code>, possibly managed by the runtime
(green-threads and all).
<br /><br />
On the JVM, with the Scalaz implementation, we can’t represent async
computations with <code>IO</code> and without blocking threads on evaluation, which is
something to avoid, because
<a href="https://monix.io/docs/2x/best-practices/blocking.html">blocking threads is error prone</a>.
</p>

<p>In summary the <code>Task</code> type:</p>

<ul>
  <li>models lazy &amp; asynchronous evaluation</li>
  <li>models a producer pushing only one value to one or multiple consumers</li>
  <li>it is lazily evaluated, so compared with <code>Future</code> it doesn’t trigger the execution, or any effects until <code>runAsync</code></li>
  <li>it is not memoized by default on evaluation, but the Monix <code>Task</code> can be</li>
  <li>doesn’t necessarily execute on another logical thread</li>
</ul>

<p>Specific to the Monix implementation:</p>

<ul>
  <li>allows for cancelling of a running computation</li>
  <li>never blocks any threads in its implementation</li>
  <li>does not expose any API calls that can block threads</li>
  <li>all async operations are stack safe</li>
</ul>

<p>A visual representation of where <code>Task</code> sits in the design space:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"> </th>
      <th style="text-align: center">Eager</th>
      <th style="text-align: center">Lazy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><strong>Synchronous</strong></td>
      <td style="text-align: center">A</td>
      <td style="text-align: center">() =&gt; A</td>
    </tr>
    <tr>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"><a href="https://monix.io/docs/2x/eval/coeval.html">Coeval[A]</a>, <a href="https://github.com/scalaz/scalaz/blob/scalaz-seven/effect/src/main/scala/scalaz/effect/IO.scala">IO[A]</a></td>
    </tr>
    <tr>
      <td style="text-align: center"><strong>Asynchronous</strong></td>
      <td style="text-align: center">(A =&gt; Unit) =&gt; Unit</td>
      <td style="text-align: center">(A =&gt; Unit) =&gt; Unit</td>
    </tr>
    <tr>
      <td style="text-align: center"> </td>
      <td style="text-align: center">Future[A]</td>
      <td style="text-align: center"><a href="https://monix.io/docs/2x/eval/task.html">Task[A]</a></td>
    </tr>
  </tbody>
</table>
      <h3 id="51-sequencing">
        
        
          5.1. Sequencing <a href="#51-sequencing" class="anchor">#</a>
        
        
      </h3>
    

<p>Redefining our function from <a href="#3-callback-hell">section 3</a> in terms of <code>Task</code>:</p>

<pre><code class="language-scala">import monix.eval.Task

def timesTwo(n: Int): Task[Int] =
  Task(n * 2)

// Usage
{
  // Our ExecutionContext needed on evaluation
  import monix.execution.Scheduler.Implicits.global

  timesTwo(20).foreach { result =&gt; println(s"Result: $result") }
  //=&gt; Result: 40
}
</code></pre>

<p>The code seems to be almost the same as the <code>Future</code> version in
<a href="#41-sequencing">section 4.1</a>, the only difference is that our <code>timesTwo</code>
function no longer takes an <code>ExecutionContext</code> as a parameter.
This is because <code>Task</code> references are lazy, being like functions,
so nothing gets printed until the call to <code>foreach</code> which forces
the evaluation to happen. It is there that we need a
<a href="https://monix.io/docs/2x/execution/scheduler.html">Scheduler</a>,
which is Monix’s enhanced <code>ExecutionContext</code>.</p>

<p>Now to do sequencing like in <a href="#31-sequencing-purgatory-of-side-effects">section 3.1</a>:</p>

<pre><code class="language-scala">def timesFour(n: Int): Task[Int] =
  for (a &lt;- timesTwo(n); b &lt;- timesTwo(n)) yield a + b

// Usage
{
  // Our ExecutionContext needed on evaluation
  import monix.execution.Scheduler.Implicits.global

  timesFour(20).foreach { result =&gt; println(s"Result: $result") }
  //=&gt; Result: 80
}
</code></pre>

<p>And just like with the <code>Future</code> type, that “<em>for comprehension</em>” magic
is translated by the Scala compiler to nothing more than calls to
<code>flatMap</code> and <code>map</code>, literally equivalent with:</p>

<pre><code class="language-scala">def timesFour(n: Int): Task[Int] =
  timesTwo(n).flatMap { a =&gt;
    timesTwo(n).map { b =&gt; a + b }
  }
</code></pre>
      <h3 id="52-parallelism">
        
        
          5.2. Parallelism <a href="#52-parallelism" class="anchor">#</a>
        
        
      </h3>
    

<p>The story for <code>Task</code> and parallelism is better than with <code>Future</code>, because
<code>Task</code> allows fine-grained control when forking tasks, while trying
to execute transformations (e.g. <code>map</code>, <code>flatMap</code>) on the current thread
and call-stack, thus preserving cache locality and avoiding context
switches for what is in essence sequential work.</p>

<p>But first, translating the sample using <code>Future</code> does not work:</p>

<pre><code class="language-scala">// BAD SAMPLE (for achieving parallelism, as this will be sequential)
def timesFour(n: Int): Task[Int] = {
  // Will not trigger execution b/c Task is lazy
  val fa = timesTwo(n)
  val fb = timesTwo(n)
  // Evaluation will be sequential b/c of laziness
  for (a &lt;- fa; b &lt;- fb) yield a + b
}
</code></pre>

<p>In order to achieve parallelism <code>Task</code> requires you to be explicit about it:</p>

<pre><code class="language-scala">def timesFour(n: Int): Task[Int] =
  Task.mapBoth(timesTwo(n), timesTwo(n))(_ + _)
</code></pre>

<p>Oh, does <code>mapBoth</code> seem familiar? If those two tasks fork threads on
execution, then they will get executed in parallel as <code>mapBoth</code> starts
them both at the same time.</p>
      <h3 id="53-recursivity">
        
        
          5.3. Recursivity <a href="#53-recursivity" class="anchor">#</a>
        
        
      </h3>
    

<p><code>Task</code> is recursive and stack-safe (in <code>flatMap</code>) and incredibly efficient, being powered
by an internal trampoline. You can checkout this cool paper by Rúnar Bjarnason on
<a href="http://blog.higher-order.com/assets/trampolines.pdf">Stackless Scala with Free Monads</a>
for getting a hint on how <code>Task</code> got implemented so efficiently.</p>

<p>The <code>sequence</code> implementation looks similar with the one for <code>Future</code>
in <a href="#43-recursivity">section 4.3</a>, except that you can see the laziness in
the signature of <code>sequence</code>:</p>

<pre><code class="language-scala">def sequence[A](list: List[Task[A]]): Task[List[A]] = {
  val seed = Task.now(List.empty[A])
  list.foldLeft(seed)((acc,f) =&gt; for (l &lt;- acc; a &lt;- f) yield a :: l)
    .map(_.reverse)
}

// Invocation
{
  // Our ExecutionContext needed on evaluation
  import monix.execution.Scheduler.Implicits.global

  sequence(List(timesTwo(10), timesTwo(20), timesTwo(30))).foreach(println)
  // =&gt; List(20, 40, 60)
}
</code></pre>
      <h2 id="6-functional-programming-and-type-classes">
        
        
          6. Functional Programming and Type-classes <a href="#6-functional-programming-and-type-classes" class="anchor">#</a>
        
        
      </h2>
    

<p>When working with well grown functions such as <code>map</code>, <code>flatMap</code> and <code>mapBoth</code>,
we no longer care that underlying it all is an “<code>(A =&gt; Unit) =&gt; Unit</code>”, because these
functions are, assuming lawfulness, pure and referentially transparent.
This means we can reason about them and their result, divorced from their
surrounding context.</p>

<p>This is the great achievement of Haskell’s <code>IO</code>. Haskell does not “fake” side-effects,
as functions returning <code>IO</code> values are literally pure, the side-effects being
pushed at the edges of the program where they belong. And we can say the same
thing about <code>Task</code>. Well, for <code>Future</code> it’s more complicated given its eager
nature, but working with <code>Future</code> is not bad either.</p>

<p>And can we build interfaces that abstract over such types as <code>Task</code>, <code>Future</code>,
<code>Coeval</code>, <code>Eval</code>, <code>IO</code>, <code>Id</code>, <code>Observable</code> and others?</p>

<p>Yes we can, we’ve already seen that <code>flatMap</code> describes sequencing, while
<code>mapBoth</code> describes parallelism. But we can’t describe them with classic
OOP interfaces, for one because due to the covariance and contravariance rules of
<code>Function1</code> parameters we’d lose type info in <code>flatMap</code> (unless you use
F-bounded polymorphic types, which are more suitable for implementation reuse and
aren’t available in other OOP languages),
but also because we need to describe a data constructor that can’t be a
method (i.e. OOP subtyping applies to instances and not whole classes).</p>

<p>Fortunately Scala is one of the very few languages capable of higher kinded
types and with the ability to encode
<a href="https://en.wikipedia.org/wiki/Type_class">type-classes</a>, which means we’ve got
everything needed to port concepts from Haskell 😄</p>

<p class="info-bubble">
<strong>Author’s Rant:</strong> The dreaded <code>Monad</code>, <code>Applicative</code> and <code>Functor</code> words
strike fear in the hearts of the unfaithful, having given rise to the belief
that they are  “academic” notions disconnected from real-world concerns,
with book authors going to great length to avoid using these words, which
includes Scala’s API documentation and official tutorials.
<br /><br />
But this is a disservice to both the Scala language and its users.
In other languages they are only design patterns that are hard to explain
primarily because they can’t be expressed as types. You can count the
languages having this expressive capability with one hand. And users suffer
because in case of trouble they don’t know how to search for existing
literature on the subject, having been deprived of learning
the correct jargon.
<br /><br />
I also feel this is a flavor of
<a href="https://en.wikipedia.org/wiki/Anti-intellectualism">anti-intellectualism</a>,
as usual born out of fear of the unknown. You can see it coming from people
that really know what they are doing, as none of us is immune. For example Java’s
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html">Optional</a>
type violates the functor laws (e.g. <code>opt.map(f).map(g) != opt.map(f andThen g)</code>),
in Swift <code>5 == Some(5)</code> which is preposterous and good luck explaining to
people that <code>Some(null)</code> actually makes sense for as long as <code>null</code> is a valid
value of <code>AnyRef</code> and because otherwise you can’t define <code>Applicative[Option]</code>.
</p>
      <h3 id="61-monad-sequencing-and-recursivity">
        
        
          6.1. Monad (Sequencing and Recursivity) <a href="#61-monad-sequencing-and-recursivity" class="anchor">#</a>
        
        
      </h3>
    

<p>This article is not about explaining Monads. There are other great articles
for that. But if you’re looking to build an intuition, here’s another one: in the
context of data types such as <code>Future</code> or <code>Task</code>, Monads describe sequencing
of operations and is the <em>only reliable</em> way to ensure ordering.</p>

<blockquote>
  <p>“<em>Observation: programmers doing concurrency with imperative languages
are tripped by the unchallenged belief that “;” defines sequencing.</em>”
– <a href="https://x.com/shipilev/status/822004316605206529">Aleksey Shipilëv</a></p>
</blockquote>

<p>A simple encoding of the <code>Monad</code> type in Scala:</p>

<pre><code class="language-scala">// We shouldn't need to do this :-(
import scala.language.higherKinds

trait Monad[F[_]] {
  /** Constructor (said to lift a value `A` in the `F[A]`
    * monadic context). Also part of `Applicative`, see below.
    */
  def pure[A](a: A): F[A]

  /** FTW */
  def flatMap[A,B](fa: F[A])(f: A =&gt; F[B]): F[B]
}
</code></pre>

<p>And providing an implementation for <code>Future</code>:</p>

<pre><code class="language-scala">import scala.concurrent._

// Supplying an instance for Future isn't clean, ExecutionContext needed
class FutureMonad(implicit ec: ExecutionContext)
  extends Monad[Future] {

  def pure[A](a: A): Future[A] =
    Future.successful(a)

  def flatMap[A,B](fa: Future[A])(f: A =&gt; Future[B]): Future[B] =
    fa.flatMap(f)
}

object FutureMonad {
  implicit def instance(implicit ec: ExecutionContext): FutureMonad =
    new FutureMonad
}
</code></pre>

<p>This is really powerful stuff. We can now describe a generic function
that works with <code>Task</code>, <code>Future</code>, <code>IO</code>, whatever, although it would be
great if the <code>flatMap</code> operation is stack-safe:</p>

<pre><code class="language-scala">/** Calculates the N-th number in a Fibonacci series. */
def fib[F[_]](n: Int)(implicit F: Monad[F]): F[BigInt] = {
  def loop(n: Int, a: BigInt, b: BigInt): F[BigInt] =
    F.flatMap(F.pure(n)) { n =&gt;
      if (n &lt;= 1) F.pure(b)
      else loop(n - 1, b, a + b)
    }

  loop(n, BigInt(0), BigInt(1))
}

// Usage:
{
  // Needed in scope
  import FutureMonad.instance
  import scala.concurrent.ExecutionContext.Implicits.global

  // Invocation
  fib[Future](40).foreach(r =&gt; println(s"Result: $r"))
  //=&gt; Result: 102334155
}
</code></pre>

<p class="info-bubble">
<strong>PRO-TIP:</strong> this is just a toy example. For getting serious,
see <a href="http://typelevel.org/cats/">Typelevel’s Cats</a>
</p>
      <h3 id="62-applicative-parallelism">
        
        
          6.2. Applicative (Parallelism) <a href="#62-applicative-parallelism" class="anchor">#</a>
        
        
      </h3>
    

<p>Monads define sequencing of operations, but sometimes we want to compose
the results of computations that are independent of each other,
that can be evaluated at the same time, possibly in parallel.
There’s also a case to be made that applicatives are more composable
than monads 😏</p>

<p>Let’s expand our mini Typeclassopedia to put on your wall:</p>

<pre><code class="language-scala">trait Functor[F[_]] {
  /** I hope we are all familiar with this one. */
  def map[A,B](fa: F[A])(f: A =&gt; B): F[B]
}

trait Applicative[F[_]] extends Functor[F] {
  /** Constructor (lifts a value `A` in the `F[A]` applicative context). */
  def pure[A](a: A): F[A]

  /** Maps over two references at the same time.
    *
    * In other implementations the applicative operation is `ap`,
    * but `map2` is easier to understand.
    */
  def map2[A,B,R](fa: F[A], fb: F[B])(f: (A,B) =&gt; R): F[R]
}

trait Monad[F[_]] extends Applicative[F] {
  def flatMap[A,B](fa: F[A])(f: A =&gt; F[B]): F[B]
}
</code></pre>

<p>And to expand our <code>Future</code> implementation:</p>

<pre><code class="language-scala">// Supplying an instance for Future isn't clean, ExecutionContext needed
class FutureMonad(implicit ec: ExecutionContext)
  extends Monad[Future] {

  def pure[A](a: A): Future[A] =
    Future.successful(a)

  def flatMap[A,B](fa: Future[A])(f: A =&gt; Future[B]): Future[B] =
    fa.flatMap(f)

  def map2[A,B,R](fa: Future[A], fb: Future[B])(f: (A,B) =&gt; R): Future[R] =
    // For Future there's no point in supplying an implementation that's
    // not based on flatMap, but that's not the case for Task ;-)
    for (a &lt;- fa; b &lt;- fb) yield f(a,b)
}

object FutureMonad {
  implicit def instance(implicit ec: ExecutionContext): FutureMonad =
    new FutureMonad
}
</code></pre>

<p>So we can now define generic functions based on <code>Applicative</code> which is going
to work for <code>Future</code>, <code>Task</code>, etc:</p>

<pre><code class="language-scala">def sequence[F[_], A](list: List[F[A]])
  (implicit F: Applicative[F]): F[List[A]] = {

  val seed = F.pure(List.empty[A])
  val r = list.foldLeft(seed)((acc,e) =&gt; F.map2(acc,e)((l,a) =&gt; a :: l))
  F.map(r)(_.reverse)
}
</code></pre>

<p class="info-bubble">
<strong>PRO-TIP:</strong> worth repeating, this is just a toy example. For getting serious,
see <a href="http://typelevel.org/cats/">Typelevel’s Cats</a>
</p>
      <h3 id="63-can-we-define-a-type-class-for-async-evaluation">
        
        
          6.3. Can We Define a Type-class for Async Evaluation? <a href="#63-can-we-define-a-type-class-for-async-evaluation" class="anchor">#</a>
        
        
      </h3>
    

<p>Missing from above is a way to actually trigger an evaluation and
get a value out. Thinking of Scala’s <code>Future</code>, we want a way to abstract
over <code>onComplete</code>. Thinking of Monix’s <code>Task</code> we want to abstract over <code>runAsync</code>.
Thinking of Haskell’s and Scalaz’s <code>IO</code>, we want a way to abstract over
<code>unsafePerformIO</code>.</p>

<p>The <a href="https://github.com/functional-streams-for-scala/fs2/">FS2</a> library has
defined a type-class called <a href="https://github.com/functional-streams-for-scala/fs2/blob/series/1.0/core/shared/src/main/scala/fs2/util/Effect.scala">Effect</a> that goes like this (simplified):</p>

<pre><code class="language-scala">trait Effect[F[_]] extends Monad[F] {
  def unsafeRunAsync[A](fa: F[A])(cb: Try[A] =&gt; Unit): Unit
}
</code></pre>

<p>This looks like our initial <code>Async</code> type, very much similar with
<code>Future.onComplete</code>, with <code>Task.runAsync</code> and could be applied to
<code>IO.unsafePerformIO</code>.</p>

<p>However, this is not a real type-class because:</p>

<ol>
  <li>it is lawless and while that’s not enough to disqualify it (after all,
useful lawless type-classes like <code>Show</code> exist), the bigger problem is …</li>
  <li>as shown in <a href="#33-recursivity-wrath-of-stackoverflow">section 3.3</a>, in order to avoid the Wrath of <code>StackOverflowError</code>,
we need some sort of execution context or thread-pool that can execute tasks
asynchronously without blowing up the stack</li>
</ol>

<p>And such an execution context is different from implementation to implementation.
Java will use <code>Executor</code>, the Scala <code>Future</code> uses <code>ExecutionContext</code>, Monix
uses <code>Scheduler</code> which is an enhanced <code>ExecutionContext</code>, FS2 and Scalaz
use <code>Strategy</code> which wraps an <code>Executor</code> for forking threads and don’t inject
a context when their <code>unsafePerformIO</code> or <code>runAsync</code> gets called
(which is why many of the Scalaz combinators are in fact unsafe), etc.</p>

<p>We could apply the same strategy as with <code>Future</code>, to build the type-class
instance by taking a <code>implicit whatever: Context</code> from the scope. But that’s
a little awkward and inefficient. It’s also telling that we can’t define
<code>flatMap</code> only in terms of <code>Effect.unsafePerformIO</code>, not without that
execution context. And if we can’t do it, then the type should probably
not inherit from <code>Monad</code> because it’s not necessarily a <code>Monad</code>.</p>

<p>So I’m personally not sure - if you have suggestions for what should be
introduced in <a href="http://typelevel.org/cats">Cats</a>, I’d love to hear them.</p>

<p>I do hope you enjoyed this thought experiment, designing things is fun 😎</p>
      <h2 id="7-picking-the-right-tool">
        
        
          7. Picking the Right Tool <a href="#7-picking-the-right-tool" class="anchor">#</a>
        
        
      </h2>
    

<p>Some abstractions are more general purpose than others and personally
I think the mantra of “<em>picking the right tool for the job</em>” is
overused to defend poor choices.</p>

<p>That said, there’s this wonderful presentation by Rúnar Bjarnason called
<a href="https://www.youtube.com/watch?v=GqmsQeSzMdw">Constraints Liberate, Liberties Constrain</a>
that really drives the point home with concurrency abstractions at least.</p>

<p>As said, there is no silver bullet that can be generally applied for dealing with concurrency.
The more high-level the abstraction, the less scope it has in solving issues. But the less scope
and power it has, the simpler and more composable the model is.
For example many developers in the Scala community are overusing Akka Actors -
which is a great library, but not when misapplied. Like don’t use an
Akka <code>Actor</code> when a <code>Future</code> or a <code>Task</code> would do. Ditto for other abstractions,
like the <code>Observable</code> pattern in Monix and ReactiveX.</p>

<p>Also learn by heart these 2 very simple rules:</p>

<ol>
  <li>avoid dealing with callbacks, threads and locks, because they are very error
prone and not composable at all</li>
  <li>avoid concurrency like the plague it is</li>
</ol>

<p>And let me tell you, concurrency experts are first of all experts in
avoiding concurrency 💀</p>

  </div>

  <div id="article-details">
    
    <time itemprop="dateModified" content="2017-01-30T00:00:00+0000">
        Published: January 30, 2017
    </time>
    | Written by <a href="https://alexn.org/about/" itemprop="url" rel="author">Alexandru Nedelcu</a>

    <div id="all-categories">
      Tags:
      
        
        <a href="/blog/tag/asynchrony/" class="category">Asynchrony</a>
      
         | 
        <a href="/blog/tag/best%20of/" class="category">Best Of</a>
      
         | 
        <a href="/blog/tag/concurrency/" class="category">Concurrency</a>
      
         | 
        <a href="/blog/tag/multithreading/" class="category">Multithreading</a>
      
         | 
        <a href="/blog/tag/scala/" class="category">Scala</a>
      
    </div>
  </div>

  
  <div class="related">
      <h2 id="related-articles">
        
        
          Related Articles <a href="#related-articles" class="anchor">#</a>
        
        
      </h2>
    
    <div class="container">
      
      
      <div class="item">
        <a class="related-link" href="/blog/2021/02/22/countdownlatch-async-dirty/">
          Implementing a CountDownLatch (async and dirty)
        </a>
        <div class="related-meta">
          <div class="tags">
            
            
              <a href="/blog/tag/concurrency" class="tag">Concurrency</a>
            
               | <a href="/blog/tag/jvm" class="tag">JVM</a>
            
               | <a href="/blog/tag/multithreading" class="tag">Multithreading</a>
            
               | <a href="/blog/tag/scala" class="tag">Scala</a>
            
               | <a href="/blog/tag/video" class="tag">Video</a>
            
          </div>
          <time>February 22, 2021</time>
        </div>
        <div class="clearfix"></div>
      </div>
      
      
      
      <div class="item">
        <a class="related-link" href="/blog/2013/05/07/towards-better-atomicreference-scala/">
          Towards a Better AtomicReference
        </a>
        <div class="related-meta">
          <div class="tags">
            
            
              <a href="/blog/tag/languages" class="tag">Languages</a>
            
               | <a href="/blog/tag/fp" class="tag">FP</a>
            
               | <a href="/blog/tag/scala" class="tag">Scala</a>
            
               | <a href="/blog/tag/java" class="tag">Java</a>
            
               | <a href="/blog/tag/multithreading" class="tag">Multithreading</a>
            
               | <a href="/blog/tag/concurrency" class="tag">Concurrency</a>
            
          </div>
          <time>May 7, 2013</time>
        </div>
        <div class="clearfix"></div>
      </div>
      
      
      
      <div class="item">
        <a class="related-link" href="/blog/2013/03/14/jvm-multithreading-monitor-locks-visibility/">
          JVM Multithreading: Monitor Locks and Visibility
        </a>
        <div class="related-meta">
          <div class="tags">
            
            
              <a href="/blog/tag/languages" class="tag">Languages</a>
            
               | <a href="/blog/tag/fp" class="tag">FP</a>
            
               | <a href="/blog/tag/scala" class="tag">Scala</a>
            
               | <a href="/blog/tag/java" class="tag">Java</a>
            
               | <a href="/blog/tag/multithreading" class="tag">Multithreading</a>
            
               | <a href="/blog/tag/concurrency" class="tag">Concurrency</a>
            
          </div>
          <time>March 14, 2013</time>
        </div>
        <div class="clearfix"></div>
      </div>
      
      
      <div class="clearfix"></div>
    </div>
  </div>
  

  
</article>

      </div>
   </div><!-- end .content -->

   <script async src="/assets/js/modernizr.custom.15390.js?202408120906" type="text/javascript"></script>
<script async src="/assets/js-managed/jquery/dist/jquery.slim.min.js?202408120906" type="text/javascript"></script>
<script async src="/assets/js/responsive-nav.min.js?202408120906" type="text/javascript"></script>

<!-- Syntax highlighting (https://highlightjs.org/) -->
<script async src="/assets/js/highlight.min.js" type="text/javascript" onload="hljs.highlightAll();"></script>

<script async src="/assets/js/scripts.js?202408120906" type="text/javascript"></script>


<script type="text/javascript">
  (function () {
    var h = "hostname" in document.location && document.location.hostname || "";
    if (h != "" && h.indexOf("alexn.org") == -1) {
      return
    }
    var p = (function () {
      var query = window.location.search.substring(1);
      var vars = query.split('&');
      var p = {};
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        p[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
      }
      return p;
    })();

    var now = new Date();
    var url = "https://ly.alexn.org/m.php?idsite=1&rec=1&action_name=Asynchronous+Programming+and+Scala&url=https%3A%2F%2Falexn.org%2Fblog%2F2017%2F01%2F30%2Fasynchronous-programming-scala%2F" +
      "&rand=" + encodeURIComponent(Math.floor(Math.random() * Number.MAX_SAFE_INTEGER)) +
      "&h=" + now.getHours() +
      "&m=" + now.getMinutes() +
      "&s=" + now.getSeconds();

    if ("pk_campaign" in p)
      url += "&_rcn=" + encodeURIComponent(p["pk_campaign"]);
    if ("pk_kwd" in p)
      url += "&_rck=" + encodeURIComponent(p["pk_kwd"]);
    if ("referrer" in document && document.referrer)
      url += "&urlref=" + encodeURIComponent(document.referrer);
    if ("screen" in window)
      url += "&res=" + screen.width + "x" + screen.height;

    var d=document, i=d.createElement("img"),s0=d.getElementsByTagName("script"),s=s0[s0.length-1];
    i.setAttribute("alt", "");
    i.setAttribute("referrerpolicy", "no-referrer-when-downgrade");
    i.setAttribute("src", url);
    i.setAttribute("width", "1");
    i.setAttribute("height", "1");
    i.setAttribute("style", "position: fixed !important; bottom: -1px !important; right: -1px !important; border:none !important; margin:0px !important;");
    s.parentNode.insertBefore(i,s);
  })();
</script>
<noscript>
  <img referrerpolicy="no-referrer-when-downgrade" src="https://ly.alexn.org/m.php?idsite=1&rec=1&action_name=Asynchronous+Programming+and+Scala&url=https%3A%2F%2Falexn.org%2Fblog%2F2017%2F01%2F30%2Fasynchronous-programming-scala%2F" width="1" height="1" style="position: fixed !important; bottom: -1px !important; right: -1px !important; border:none !important; margin:0px !important;" alt="" />
</noscript>

   <div class="footer">
  
  <div class="container">
    <div class="contributions">
      <div id="footer-comments-widget">
  <h2 id="comments">
  Comments
  <a href="#comments" class="anchor">#</a>
</h2>

<div class="only-js">
  Want to chat in private? Email me:
  <script id="email-script">
    (function () {
      var lhs = "low.flag5454";
      var rhs = "ac.alexn.org";
      var d = document;
      var a = d.createElement("a");
      a.setAttribute("target", "_blank");
      a.setAttribute("href", "mailto:" + lhs + "@" + rhs + "?subject=Comment%20on%3A%20Asynchronous%20Programming%20and%20Scala");
      a.text = lhs + "@" + rhs;
      var es = d.getElementById("email-script");
      es.parentNode.insertBefore(a, es);
    })();
  </script>
  <noscript>
    <em>Email address is protected via JavaScript, activate it to see it!</em>
  </noscript>

  <p class="small-note">
    The address is changed periodically to avoid spam.
  </p>
</div>


<div id="comments">
  <script async
          data-isso="https://alexn.org/comments/alexn/"
          data-isso-css="false"
          data-isso-lang="en"
          data-isso-reply-to-self="true"
          data-isso-require-author="true"
          data-isso-require-email="false"
          data-isso-reply-notifications="true"
          data-isso-max-comments-top="30"
          data-isso-max-comments-nested="20"
          data-isso-reveal-on-click="20"
          data-isso-gravatar="true"
          data-isso-avatar="false"
          data-isso-vote="false"
          data-vote-levels=""
          src="https://alexn.org/comments/alexn/js/embed.min.js"></script>
  <section id="isso-thread" data-title="Asynchronous Programming and Scala">
  </section>
</div>
<noscript>
  <div class="note-warning">
    <strong>Enable JavaScript to see the email address or the public comments!</strong>
    <br>
    <span class="extra">
      Commenting widget is powered by a self-hosted commenting server.
      <span style="white-space: nowrap;">
        Read the <a href="/docs/privacy-policy/">privacy policy</a>.
      </span>
    </span>
  </div>
</noscript>

</div>

<h2 id="contribute">
  Contribute
  <a href="#contribute" class="anchor">#</a>
</h2>

<p>
  Fix or add to this article by submitting a pull request:<br/>
  <a style="white-space: nowrap;" href="https://github.com/alexandru/alexn.org/blob/main/_posts/2017-01-30-asynchronous-programming-scala.md" target="_blank">Edit Page on GitHub</a>
</p>

<p>
  Donate to cover ongoing website costs, or buy me coffee ☕️😋 <br/>
  <a href="https://www.patreon.com/bePatron?u=6102596" target="_blank" class="patreon-button">
    <img label="Become a Patron!" alt="Become a Patron!" title="Become a Patron!" src="/assets/media/buttons/patreon.png" />
  </a>
</p>


<h2 id="subscribe">
  Subscribe
  <a href="#subscribe" class="anchor">#</a>
</h2>

<p>  
  <a target="_blank" href="https://alexn.us4.list-manage.com/subscribe?u=5bffa2af025192a58345bd5dc&id=1c9005b255" rel="nofollow"><span class="link-logo"><img src="/assets/logo/email.svg" /></span>Subscribe by email</a>
  and receive notifications for new blog articles. No spam, just content. 
  Powered by <a href="https://mailchimp.com/" rel="nofollow" target="_blank">Mailchimp</a>. 
  See <a href="/docs/privacy-policy/#email-newsletter">privacy policy</a>.
</p>

<!-- Begin Mailchimp Signup Form -->
<div id="mc_embed_signup">
  <form action="https://alexn.us4.list-manage.com/subscribe/post?u=5bffa2af025192a58345bd5dc&amp;id=1c9005b255"
    method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank"
    novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="mc-field-group field">
        <label for="mce-EMAIL">Email Address <sup class="asterisk">*</sup></label>
        <input type="email" value="" name="EMAIL" class="required email full-width" id="mce-EMAIL" placeholder="user@domain.com" required>
      </div>
      <!-- <div class="mc-field-group field">
        <label for="mce-FULLNAME">Name</label>
        <input type="text" value="" name="FULLNAME" class="full-width" id="mce-FULLNAME" placeholder="John Doe">
      </div> -->
      <div id="mce-responses" class="clear">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
      </div>
      <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text"
          name="b_5bffa2af025192a58345bd5dc_1c9005b255" tabindex="-1" value=""></div>
      <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe"
          class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->


    </div>
  </div>
  

  <div class="bottom">
    <div class="container">
      <span class="copy">
          &copy; 2009-2024
      </span>
      <span class="links">
        <a href="/docs/license/">License</a> |
        <a href="/docs/privacy-policy/">Privacy Policy</a> |
        <a href="/about/#contact">Contact</a>
        <span id="other-social-profiles" class="hidden">
          | <a href="https://social.alexn.org/@alexelcu" rel="me">Social</a>
        </span>
      </span>
    </div>
  </div>
</div><!-- end .footer -->

</body>
</html>
